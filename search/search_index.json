{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"]},"docs":[{"location":"","title":"Bismark Bisulfite Mapper","text":"<p>This User Guide outlines the Bismark suite of tools and gives more details for each individual step. For troubleshooting some of the more commonly experienced problems in sequencing in general and bisulfite-sequencing in particular please browse through the sequencing section at QCFail.com.</p>"},{"location":"#general-information","title":"General Information","text":""},{"location":"#what-is-bismark","title":"What is Bismark?","text":"<p>Bismark is a set of tools for the time-efficient analysis of Bisulfite-Seq (BS-Seq) data. Bismark performs alignments of bisulfite-treated reads to a reference genome and cytosine methylation calls at the same time. Bismark is written in Perl and is run from the command line. Bisulfite-treated reads are mapped using the short read aligner Bowtie 2, or alternatively HISAT2. Therefore, it is a requirement that Bowtie 2 (or HISAT2) are also installed on your machine (see Dependencies).</p> <p>All files associated with Bismark as well as a test BS-Seq data set can be downloaded from Github.</p> <p>We would like to hear your comments, suggestions or bugs about Bismark! Please e-mail them to: fkrueger@altoslabs.com</p>"},{"location":"#which-kind-of-bs-seq-files-are-supported","title":"Which kind of BS-Seq files are supported?","text":"<p>Bismark supports the alignment of bisulfite-treated reads (whole genome shotgun BS-Seq (WGSBS), reduced-representation BS-Seq (RRBS) or PBAT-Seq (Post-Bisulfite Adapter Tagging) for the following conditions:</p> <ul> <li>sequence format either <code>FastQ</code> or <code>FastA</code></li> <li>single-end or paired-end reads</li> <li>input files can be uncompressed or <code>gzip</code>-compressed (ending in <code>.gz</code>)</li> <li>variable read length support</li> <li>directional or non-directional BS-Seq libraries</li> </ul> <p>A full list of alignments modes can be found in <code>Bismark_alignment_modes.pdf</code>.</p> <p>In addition, Bismark retains much of the flexibility of Bowtie 2 / HISAT2 / minimap2 (adjustable seed length, number of mismatches, insert size ...). For a full list of options please run:</p> <pre><code>bismark --help\n</code></pre> <p>or see the Appendix at the end of this User Guide.</p> <p>NOTE: It should be mentioned that Bismark supports only reads in base-space, such as from the Illumina platform. There are currently no plans to extend its functionality to colour-space reads from the SOLiD platform.</p>"},{"location":"#how-does-bismark-work","title":"How does Bismark work?","text":"<p>Sequence reads are first transformed into fully bisulfite-converted forward (C-&gt;T) and reverse read (G-&gt;A conversion of the forward strand) versions, before they are aligned to similarly converted versions of the genome (also C-&gt;T and G-&gt;A converted). Sequence reads that produce a unique best alignment from the four alignment processes against the bisulfite genomes (which are running in parallel) are then compared to the normal genomic sequence and the methylation state of all cytosine positions in the read is inferred. A read is considered to align uniquely if an alignment has a unique best alignment score (as reported by the <code>AS:i</code> field). If a read produces several alignments with the same number of mismatches or with the same alignment score (<code>AS:i</code> field), a read (or a read-pair) is discarded altogether.</p>"},{"location":"#bismark-alignment-and-methylation-call-report","title":"Bismark alignment and methylation call report","text":"<p>Upon completion, Bismark produces a run report containing information about the following:</p> <ul> <li>Summary of alignment parameters used</li> <li>Number of sequences analysed</li> <li>Number of sequences with a unique best alignment (mapping efficiency)</li> <li>Statistics summarising the bisulfite strand the unique best alignments came from</li> <li>Number of cytosines analysed</li> <li>Number of methylated and unmethylated cytosines</li> <li>Percentage methylation of cytosines in CpG, CHG or CHH context (where H can be either A, T or C). This percentage is calculated individually for each context following the equation:</li> </ul> <p>% methylation (context) = 100 * methylated Cs (context) / (methylated Cs (context) + unmethylated Cs (context)).</p> <p>It should be stressed that the percent methylation value (context) is just a very rough calculation performed directly at the mapping step. Actual methylation levels after post-processing or filtering have been applied may vary.</p>"},{"location":"#credits","title":"Credits","text":"<p>Bismark was written by Felix Krueger at the Babraham Bioinformatics Group, now at Altos Labs, Cambridge Institute.</p> <p></p>"},{"location":"installation/","title":"Installation","text":"<p>Bismark is written in Perl and is executed from the command line. To install Bismark simply copy the bismark_v0.X.Y.tar.gz file into a Bismark installation folder and extract all files by typing:</p> <pre><code>tar xzf bismark_v0.X.Y.tar.gz\n</code></pre>"},{"location":"installation/#dependencies","title":"Dependencies","text":"<p>Bismark requires a working of Perl and Bowtie 2 (or HISAT2) to be installed on your machine. Bismark will assume that the Bowtie 2/ HISAT2 executable is in your path unless the path to Bowtie/ HISAT2 is specified manually with:</p> <pre><code>--path_to_bowtie2 &lt;/../../bowtie2&gt; or\n--path_to_hisat2 &lt;/../../hisat2&gt;\n</code></pre>"},{"location":"installation/#hardware-requirements","title":"Hardware requirements","text":"<p>Bismark holds the reference genome in memory, and in addition to that runs up to four parallel instances of Bowtie 2. The memory usage is dependent on the size of the reference genome. For a large eukaryotic genome (human or mouse) we experienced a typical memory usage of around 12GB. We thus recommend running Bismark on a machine with 5 CPU cores and at least 12 GB of RAM. The memory requirements of Bowtie 2 are somewhat larger (possibly to allow gapped alignments). When running Bismark using Bowtie 2 we therefore recommend a system with at least 5 cores and &gt; 16GB of RAM.</p> <p>Alignment speed depends largely on the read length and alignment parameters used. Allowing many mismatches and using a short seed length tends to be fairly slow.</p>"},{"location":"installation/#bs-seq-test-data-set","title":"BS-Seq test data set","text":"<p>A test BS-Seq data set is available for download from the Bismark project or Github pages. It contains 10,000 single- end shotgun BS reads from human ES cells in FastQ format (from SRR020138, Lister et al., 2009; trimmed to 50 bp; base call qualities are Sanger encoded Phred values (Phred33)).</p>"},{"location":"installation/#bismark-reports-for-the-test-data-set","title":"Bismark reports for the test data set","text":"<p>Please note that this has been run with a fairly early version however I wouldn't expect the numbers to change much.</p>"},{"location":"installation/#using-bowtie-2","title":"Using Bowtie 2:","text":"<p>Running Bismark with the following options:</p> <pre><code>bismark --score-min L,0,-0.6 /data/public/Genomes/Human/GRCh37/ test_data.fastq\n</code></pre> <p>Should result in this mapping report:</p> <pre><code>Bismark report for: test_data.fastq (version: v0.7.8)\nOption '--directional' specified: alignments to complementary strands will be ignored (i.e. not performed!)\nBowtie2 was run against the bisulfite genome of /data/public/Genomes/Human/GRCh37/ with the specified options: -q -- score-min L,0,-0.6 --ignore-quals\n\nFinal Alignment report\n======================\nSequences analysed in total: 10000\n\nNumber of alignments with a unique best hit from the different alignments: 5658 Mapping efficiency: 56.6%\nSequences with no alignments under any condition: 2893\nSequences did not map uniquely: 1449\nSequences which were discarded because genomic sequence could not be extracted: 0\nNumber of alignments to (merely theoretical) complementary strands being rejected in total: 0\n\nNumber of sequences with unique best (first) alignment came from the bowtie output:\n\nCT/CT: 2820 ((converted) top strand)\nCT/GA: 2838 ((converted) bottom strand)\nGA/CT: 0    (complementary to (converted) top strand)\nGA/GA: 0    (complementary to (converted) bottom strand)\n\nFinal Cytosine Methylation Report\n=================================\nTotal number of C's analysed: 45985\n\nTotal methylated C's in CpG context: 1550\nTotal methylated C's in CHG context: 34\nTotal methylated C's in CHH context: 126\n\nTotal C to T conversions in CpG context: 844\nTotal C to T conversions in CHG context: 11368\nTotal C to T conversions in CHH context:32063\n\nC methylated in CpG context: 64.7%\nC methylated in CHG context: 0.3%\nC methylated in CHH context: 0.4%\n</code></pre>"},{"location":"quick_reference/","title":"Quick Reference","text":"<p>Bismark needs a working version of Perl and it is run from the command line. Furthermore, Bowtie 2 or HISAT2 needs to be installed on your computer. For more information on how to run Bismark with Bowtie 2 please go to the end of this manual.</p> <p>As of version 0.14.0 or higher, Bismark may be run using parallelisation for both the alignment and the methylation extraction step. Search for <code>--parallel</code> / <code>--multicore</code> for more details below.</p> <p>First you need to download a reference genome and place it in a genome folder. Genomes can be obtained e.g. from the Ensembl or NCBI websites. For the example below you would need to download the Homo sapiens genome. Bismark supports reference genome sequence files in <code>FastA</code> format, allowed file extensions are either either <code>.fa</code> or <code>.fasta</code>. Both single-entry and multiple-entry <code>FastA</code> files are supported.</p> <p>The following examples will use the file <code>test_dataset.fastq</code> which is available for download from the Bismark project or Github pages (it contains 10,000 reads in FastQ format, Phred33 qualities, 50 bp long reads, from a human directional BS-Seq library). An example report can be found in Appendix IV.</p>"},{"location":"quick_reference/#genome-preparation","title":"Genome preparation","text":"<p>USAGE:</p> <pre><code>bismark_genome_preparation [options] &lt;path_to_genome_folder&gt;\n</code></pre> <p>A typical genome indexing could look like this:</p> <pre><code>/bismark/bismark_genome_preparation --path_to_aligner /usr/bin/bowtie2/ --verbose /data/genomes/homo_sapiens/GRCh37/\n</code></pre>"},{"location":"quick_reference/#alignment","title":"Alignment","text":"<p>USAGE:</p> <pre><code>bismark [options] --genome &lt;genome_folder&gt; {-1 &lt;mates1&gt; -2 &lt;mates2&gt; | &lt;singles&gt;}\n</code></pre> <p>Typical alignment example:</p> <pre><code>bismark --genome /data/genomes/homo_sapiens/GRCh37/ test_dataset.fastq\n</code></pre> <p>This will produce two output files:</p> <ol> <li><code>test_dataset_bismark_bt2.bam</code> (contains all alignments plus methylation call strings)</li> <li><code>test_dataset_bismark_SE_report.txt</code> (contains alignment and methylation summary)</li> </ol> <p>Note</p> <p>In order to work properly the current working directory must contain the sequence files to be analysed.</p>"},{"location":"quick_reference/#deduplication","title":"Deduplication","text":"<pre><code>deduplicate_bismark --bam [options] &lt;filenames&gt;\n</code></pre> <p>This command will deduplicate the Bismark alignment BAM file and remove all reads but one which align to the the very same position and in the same orientation. This step is recommended for whole-genome bisulfite samples, but should not be used for reduced representation libraries such as RRBS, amplicon or target enrichment libraries.</p>"},{"location":"quick_reference/#methylation-extraction","title":"Methylation extraction","text":"<p>USAGE:</p> <pre><code>bismark_methylation_extractor [options] &lt;filenames&gt;\n</code></pre> <p>A typical command to extract context-dependent (CpG/CHG/CHH) methylation could look like this:</p> <pre><code>bismark_methylation_extractor --gzip --bedGraph test_dataset_bismark_bt2.bam\n</code></pre> <p>This will produce three methytlation output files:</p> <ul> <li><code>CpG_context_test_dataset_bismark_bt2.txt.gz</code></li> <li><code>CHG_context_test_dataset_bismark_bt2.txt.gz</code></li> <li><code>CHH_context_test_dataset_bismark_bt2.txt.gz</code></li> </ul> <p>as well as a bedGraph and a Bismark coverage file. For more on these files and their formats please see below.</p>"},{"location":"quick_reference/#sample-report","title":"Sample report","text":"<p>USAGE:</p> <pre><code>bismark2report [options]\n</code></pre> <p>This command attempts to find Bismark alignment, deduplication and methylation extraction (splitting) reports as well as M-bias files to generate a graphical HTML report such as this example Bismark paired-end report for each sample in a directory.</p>"},{"location":"quick_reference/#summary-report","title":"Summary report","text":"<p>USAGE:</p> <pre><code>bismark2summary [options]\n</code></pre> <p>This command scans the current working directory for different Bismark alignment, deduplication and methylation extraction (splitting) reports to produce a graphical summary HTML report, as well as a data table, for all files in a directory. Here is a sample Bismark Summary Report. The Bismark summary report is meant to give you a quick visual overview of the alignment statistics for a large number of samples (tens, hundreds or thousands of samples); if you only want to look at a single report please check out the <code>bismark2report</code>.</p>"},{"location":"bismark/","title":"Running Bismark","text":"<p>Running Bismark is split up into three main steps:</p> <ol> <li>First, the genome of interest needs to be bisulfite converted and indexed to allow Bowtie alignments. This step needs to be carried out only once for each genome. Note that Bowtie 2 and HISAT2 require distinct indexing steps since their indexes are not compatible.</li> <li>Bismark read alignment step. Simply specify a file to be analysed, a reference genome and alignment parameters. Bismark will produce a combined alignment/methylation call output (default is BAM format) as well as a run statistics report.</li> <li>Bismark methylation extractor. This step is optional and will extract the methylation information from the Bismark alignment output. Running this additional step allows splitting the methylation information up into the different contexts, getting strand-specific methylation information and offers some filtering options. You can also choose to sort the methylation information into <code>bedGraph</code>/<code>coverage</code> files, or even process them further to genome-wide cytosine methylation reports.</li> </ol> <p>Each of these steps will be described in more detail (with examples) in the following sections.</p>"},{"location":"bismark/alignment/","title":"Alignment","text":"<p>This step represents the actual bisulfite alignment and methylation calling part. Bismark requires the user to specify only two things:</p> <ol> <li>The directory containing the genome of interest. This folder must contain the unmodified genome (as <code>.fa</code> or <code>.fasta</code> files) as well as the two bisulfite genome subdirectories which were generated in the Bismark Genome Preparations step (see above).</li> <li>The sequence file(s) to be analysed (in either <code>FastQ</code> or <code>FastA</code> format).</li> </ol> <p>All other parameters are optional.</p> <p>For each sequence file or each set of paired-end sequence files, Bismark produces one alignment and methylation call output file as well as a report file detailing alignment and methylation call statistics for your information and record keeping.</p>"},{"location":"bismark/alignment/#running-bismark","title":"Running <code>bismark</code>","text":"<p>Before running Bismark we recommend spending some time on quality control of the raw sequence files using FastQC. FastQC might be able to spot irregularities associated with your BS-Seq file, such as high base calling error rates or contaminating sequences such as PCR primers or Illumina adapters. Many sources of error impact detrimentally the alignment efficiencies and/or alignment positions, and thus possibly also affect the methylation calls and conclusions drawn from the experiment.</p> <p>If no additional options are specified Bismark will use a set of default values, some of which are:</p>"},{"location":"bismark/alignment/#using-bowtie-2","title":"Using Bowtie 2:","text":"<ul> <li>Using Bowtie 2 is the default mode</li> <li>If no specific path to Bowtie 2 is specified it is assumed that the <code>bowtie2</code> executable is in the <code>PATH</code></li> <li>Standard alignments use a multi-seed length of 20bp with 0 mismatches. These parameters can be modified using the options <code>-L</code> and <code>-N</code>, respectively</li> <li>Standard alignments use the default minimum alignment score function L,0,-0.2, i.e. f(x) = 0 + -0.2 * x (where x is the read length). For a read of 75bp this would mean that a read can have a lowest alignment score of -15 before an alignment would become invalid. This is roughly equal to 2 mismatches or ~2 indels of 1-2 bp in the read (or a combination thereof). The stringency can be set using the <code>--score_min &lt;func&gt;</code> function.</li> </ul> <p>Even though the user is not required to specify additional alignment options it is often advisable to do so (e.g. when the default parameters are too strict). To see a full list of options please type <code>bismark --help</code> on the command line or see the Appendix at the end of this User Guide.</p>"},{"location":"bismark/alignment/#directional-bs-seq-libraries-default","title":"Directional BS-Seq libraries (default)","text":"<p>Bisulfite treatment of DNA and subsequent PCR amplification can give rise to four (bisulfite converted) strands for a given locus. Depending on the adapters used, BS-Seq libraries can be constructed in two different ways:</p> <ol> <li>If a library is directional, only reads which are (bisulfite converted) versions of the original top strand (OT) or the original bottom strand (OB) will be sequenced. Even though the strands complementary to OT (CTOT) and OB (CTOB) are generated in the BS-PCR step they will not be sequenced as they carry the wrong kind of adapter at their 5\u2019-end. By default, Bismark performs only 2 read alignments to the OT and OB strands, thereby ignoring alignments coming from the complementary strands as they should theoretically not be present in the BS-Seq library in question.</li> <li>Alternatively, BS-Seq libraries can be constructed so that all four different strands generated in the BS-PCR can and will end up in the sequencing library with roughly the same likelihood. In this case all four strands (OT, CTOT, OB, CTOB) can produce valid alignments and the library is called non- directional. Specifying <code>--non_directional</code> instructs Bismark to use all four alignment outputs.</li> </ol> <p>To summarise again: alignments to the original top strand or to the strand complementary to the original top strand (OT and CTOT) will both yield methylation information for cytosines on the top strand. Alignments to the original bottom strand or to the strand complementary to the original bottom strand (OB and CTOB) will both yield methylation information for cytosines on the bottom strand, i.e. they will appear to yield methylation information for G positions on the top strand of the reference genome.</p> <p>For more information about how to extract methylation information of the four different alignment strands please see below in the section on the Bismark methylation extractor.</p> <p>USAGE:</p> <pre><code>bismark [options] --genome &lt;genome_folder&gt; {-1 &lt;mates1&gt; -2 &lt;mates2&gt; | &lt;singles&gt;}\n</code></pre> <p>A typical single-end analysis could look like this:</p> <pre><code>bismark --genome /data/genomes/homo_sapiens/GRCh38/ sample.fastq.gz\n</code></pre>"},{"location":"bismark/alignment/#what-does-the-bismark-output-look-like","title":"What does the Bismark output look like?","text":"<p>Since version 0.6.x the default output of Bismark is in BAM/SAM format (which is required to encode gapped alignments).</p>"},{"location":"bismark/alignment/#bismark-bamsam-output-default","title":"Bismark BAM/SAM output (default)","text":"<p>By default, Bismark generates SAM output for all alignment modes. Please note that reported quality values are encoded in Sanger format (Phred 33 scale), even if the input was in Phred64.</p> <ol> <li><code>QNAME</code> (seq-ID)</li> <li><code>FLAG</code> (this flag tries to take the strand a bisulfite read originated from into account (this is different from ordinary DNA alignment flags!))</li> <li><code>RNAME</code> (chromosome)</li> <li><code>POS</code> (start position)</li> <li><code>MAPQ</code> (calculated for Bowtie 2 and HISAT2)</li> <li><code>CIGAR</code></li> <li><code>RNEXT</code></li> <li><code>PNEXT</code></li> <li><code>TLEN</code></li> <li><code>SEQ</code></li> <li><code>QUAL</code> (Phred33 scale)</li> <li><code>NM-tag</code> (edit distance to the reference)</li> <li><code>MD-tag</code> (base-by-base mismatches to the reference) (14) XM-tag (methylation call string)</li> <li><code>XR-tag</code> (read conversion state for the alignment) (16) XG-tag (genome conversion state for the alignment)</li> </ol> <p>The mate read of paired-end alignments is written out as an additional separate line in the same format.</p>"},{"location":"bismark/alignment/#bam-compression-with-genozip","title":"BAM compression with Genozip","text":"<p>Info</p> <p>3rd party program notice.</p> <p>Information valid as of: 21/09/2022.</p> <p>Genozip v14 and above supports the compression of Bismark-generated BAM files. A benchmark with a Bismark test file (PE) showed that compression resulted in a 7X vs BAM and more than 2X vs CRAM 3.1 (see this issue). More information on Genozip on its website, conda installation <code>conda install genozip</code>.</p> <p>Please note that while Genozip is free for academic use, it is a commercial product, so users would need to register to it separately.</p>"},{"location":"bismark/alignment/#data-visualisation","title":"Data visualisation","text":"<p>To see the location of the mapped reads the Bismark output file can be imported into a genome viewer, such as SeqMonk, using the chromosome, start and end positions (this can be useful to identify regions in the genome which display an artefactually high number of aligned reads). The alignment output can also be used to apply post-processing steps such as de-duplication (allowing only 1 read for each position in the genome to remove PCR artefacts) or filtering on the number of bisulfite conversion related non-bisulfite mismatches * (please note that such post-processing scripts are not part of the Bismark package).</p> <p>Tip</p> <p>Bisulfite conversion related non-bisulfite mismatches are mismatch positions which have a C in the BS-read but a T in the genome; such mismatches may occur due to the way bisulfite read alignments are performed. Reads containing this kind of mismatches are not automatically removed from the alignment output in order not to introduce a bias for methylated reads.</p> <p>It should be noted that, even though no methylation calls are performed for these positions, reads containing bisulfite conversion related non-bisulfite mismatches might lead to false alignments if particularly lax alignment parameters were specified.</p>"},{"location":"bismark/alignment/#methylation-call","title":"Methylation call","text":"<p>The methylation call string contains a dot <code>.</code> for every position in the BS-read not involving a cytosine, or contains one of the following letters for the three different cytosine methylation contexts (UPPER CASE = METHYLATED, lower case = unmethylated):</p> <ul> <li><code>z</code> - C in CpG context - unmethylated</li> <li><code>Z</code> - C in CpG context - methylated</li> <li><code>x</code> - C in CHG context - unmethylated</li> <li><code>X</code> - C in CHG context - methylated</li> <li><code>h</code> - C in CHH context - unmethylated</li> <li><code>H</code> - C in CHH context - methylated</li> <li><code>u</code> - C in Unknown context (CN or CHN) - unmethylated</li> <li><code>U</code> - C in Unknown context (CN or CHN) - methylated</li> <li><code>.</code> - not a C or irrelevant position</li> </ul>"},{"location":"bismark/alignment/#local-alignments-in-bowtie-2-or-hisat2-mode","title":"Local alignments in Bowtie 2 or HISAT2 mode","text":"<p>Note</p> <p>This has been previously only been mentioned in the release notes here: https://github.com/FelixKrueger/Bismark/releases/tag/0.22.0</p> <p>Expanding on our observation that single-cell BS-seq, or PBAT libraries in general, can generate chimeric read pairs, a publication by Wu et al. described in further detail that intra-fragment chimeras can hinder the efficient alignment of single-cell BS-seq libraries. In there, the authors described a pipeline that uses paired-end alignments first, followed by a second, single-end alignment step that uses local alignments in a bid to improve the mapping of intra-molecular chimeras. To allow this type of improvement for single-cell or PBAT libraries, Bismark also allows the use of local alignments.</p> <p>Please note that we still do not recommend using local alignments as a means to magically increase mapping efficiencies (please see here), but we do acknowledge that PBAT/scBSs-seq/scNMT-seq are exceptional applications where local alignments might indeed make a difference (there is only so much data to be had from a single cell...). We didn't have the time yet to set more appropriate or stringent default values for local alignments (suggestions welcome), nor did we investigate whether the methylation extraction will require an additional <code>--ignore</code> flag if a read was found to the be soft-clipped (the so called 'micro-homology domains'). This might be added in the near future.</p>"},{"location":"bismark/concordance/","title":"Concordance across reads","text":"<p>Methylation is typically thought to be laid down in longer stretches rather than appearing sporadically at individual cytosines. As a consequence, several CpGs within a given read are often found either completely methylated or completely unmethylated. A mixed methylation pattern may be used to assess the concordance of the methylation signal, which could be a proxy of the fidelity of maintenance methylation etc.</p> <p>The script <code>methylation_consistency</code> takes in a BAM file generated by Bismark and splits it into three smaller BAM files, based on the consistency/concordance of the methylation calls within the file. The reads are split into those which show consistent methylation, un-methylation and mixed methylation, and only methylation in CpG context is considered. In its default condition, reads are considered as:</p> <pre><code>unmethylated  0 -  10% methylated (inclusive)\nmixed:       10 -  90% methylated\nmethylated:  90 - 100% methylated (inclusive)\n</code></pre> <p></p> <p>A consistency report looks roughly like this:</p> <pre><code>Total paired-end records     -  478498\n-------------------------------------------------\nAll methylated    [ &gt;= 90% ] -  10304 (2.15%)\nAll unmethylated  [ &lt;= 10% ] -  31806 (6.65%)\nMixed methylation [ 10-90% ] -  30176 (6.31%)\nToo few CpGs   [min-count 5] -  406212 (84.89%)\n</code></pre> <p>By default, only reads with 5 or more CpGs are taken into consideration (this can be changed via the flag <code>--min-count</code>). The thresholds for un-methylated, mixed methylated, and methylated can be set with <code>--lower_threshold [percentage]</code> and <code>--upper_threshold [percentage]</code>. <code>methylation_consistency</code> works for both single-end and paired-end Bismark BAM files, which are auto-detected by default. For paired-end files, all CpGs of both R1 and R2 are taken into account. Overlap detection/exclusion can take place afterwards at the methylation extraction stage, if desired.</p>"},{"location":"bismark/coverage_report/","title":"Nucleotide coverage report","text":"<p>The script <code>bam2nuc</code> reads BAM files and calculates the mono- and di-nucleotide coverage of the reads (using the genomic sequence rather than the observed sequence in the reads themselves) and compares it to the average genomic sequence composition. Reads harbouring InDels are not taken into consideration. Mono- or dinucleotides containing Ns are ignored as well.</p>"},{"location":"bismark/coverage_report/#usage","title":"Usage","text":"<pre><code>bam2nuc [options] --genome_folder &lt;path&gt; [input.(bam|cram)]\n</code></pre>"},{"location":"bismark/coverage_report/#arguments","title":"Arguments","text":"<p>Aligned BAM files. <code>bam2nuc</code> handles both Bismark single-end and paired-end files (determined automatically).</p> <p>Note</p> <p>Both BAM and CRAM files should work as input, but please note that Samtools version 1.2 or higher is required for CRAM files.</p>"},{"location":"bismark/coverage_report/#options","title":"Options","text":"<ul> <li><code>--dir</code></li> </ul> <p>Output directory. Output is written to the current directory if not specified explicitly.</p> <ul> <li><code>--genome_folder &lt;path&gt;</code></li> </ul> <p>Enter the genome folder you wish to use to extract sequences from (full path only). Accepted formats are FastA files ending with <code>.fa</code> or <code>.fasta</code>. Specifying a genome folder path is mandatory.</p> <ul> <li><code>--samtools_path</code></li> </ul> <p>The path to your Samtools installation, e.g. <code>/home/user/samtools/</code>. Does not need to be specified explicitly if Samtools is in the <code>PATH</code> already</p> <ul> <li><code>--genomic_composition_only</code></li> </ul> <p>Only calculate and extract the genomic sequence composition and exit thereafter.</p> <p>This option will attempt to write the genomic composition table <code>genomic_nucleotide_frequencies.txt</code> to the genome folder or to the output directory instead if that doesn't succeed.</p> <ul> <li><code>--help</code></li> </ul> <p>Displays this help message and exits</p>"},{"location":"bismark/coverage_report/#genomic-composition","title":"Genomic composition","text":"<p>Since the calculation of the average genomic (di-)nucleotide composition may take a while, <code>bam2nuc</code> attempts to write out a file called 'genomic_nucleotide_frequencies.txt' to the genome folder if it wasn't there already. The next time <code>bam2nuc</code> is run it will then use this file instead of calculating the average genome composition again. If writing to the genome folder fails (e.g. because of permission issues) it will be written out to the output directory instead.</p>"},{"location":"bismark/coverage_report/#output-format","title":"Output format","text":"<p><code>bam2nuc</code> writes out a file ending in <code>.nucleotide_stats.txt</code> in the following format (tab-delimited):</p> sample.nucleotide_stats.txt<pre><code>(di-)nucleotide count sample    percent sample  count genomic   percent genomic coverage\nA       14541   30.91   3768086 30.98   0.004\nC       8893    18.90   2321832 19.09   0.004\nG       9019    19.17   2318192 19.06   0.004\nT       14597   31.02   3754886 30.87   0.004\nAA      5008    10.86   1321485 10.86   0.004\nAC      2355    5.11    639783  5.26    0.004\nAG      2692    5.84    709163  5.83    0.004\nAT      4191    9.09    1097652 9.02    0.004\nCA      2912    6.32    786744  6.47    0.004\nCC      1812    3.93    473900  3.90    0.004\nCG      1341    2.91    355535  2.92    0.004\nCT      2659    5.77    705653  5.80    0.004\nGA      2903    6.30    756411  6.22    0.004\nGC      1724    3.74    453607  3.73    0.004\nGG      1817    3.94    470732  3.87    0.004\nGT      2402    5.21    637436  5.24    0.004\nTA      3419    7.42    903441  7.43    0.004\nTC      2823    6.12    754531  6.20    0.004\nTG      2996    6.50    782761  6.44    0.004\nTT      5055    10.96   1314144 10.80   0.004\n</code></pre> <p>This file is picked up and plotted by <code>bismark2report</code> automatically if found in the folder in the following manner:</p> <p></p>"},{"location":"bismark/deduplication/","title":"Deduplication","text":"<p>USAGE:</p> <pre><code>./deduplicate_bismark [options] filename(s)\n</code></pre> <p>The script <code>deduplicate_bismark</code> is supposed to remove alignments to the same position in the genome from the Bismark mapping output (both single and paired-end SAM/BAM files), which can arise by e.g. excessive PCR amplification. Sequences which align to the same genomic position but on different strands are scored individually.</p> <p>It is important to note that deduplication is not recommended for RRBS, amplicon or other target enrichment-type libraries!</p> <p>In the default mode, the first alignment to a given position will be used irrespective of its methylation call. As the alignments are not ordered in any way this is near enough a random read for each position.</p> <p>For single-end alignments, only the chromosome, start coordinate and strand of a read will be used for deduplication.</p> <p>For paired-end alignments, the chromosome, the strand of a read pair, the start-coordinate of the first read as well as the start coordinate of the second read will be used for deduplication. This script expects the Bismark output to be in SAM/BAM format.</p> <p>Please note that for paired-end BAM files the deduplication script expects Read 1 and Read 2 to follow each other in consecutive lines! If the file has been sorted by position for whatever reason, please make sure that you resort it by read name first (e.g. using <code>samtools sort -n</code>)</p>"},{"location":"bismark/deduplication/#deduplication-using-umis-or-barcodes","title":"Deduplication using UMIs or barcodes","text":"<p>In addition to chromosome, start (and end position for paired-end libraries) position and strand orientation the option <code>--barcode</code> will also take a potential barcodes or UMIs (unique molecular identifiers) into consideration while deduplicating. The barcode needs to be the last element of the read ID and has to beseparated by a <code>:</code>, e.g.:</p> <pre><code>MISEQ:14:000000000-A55D0:1:1101:18024:2858_1:N:0:CTCCT\n</code></pre> <p>This option is equivalent to using UmiBam in the following mode: <code>UmiBam --umi input.bam</code>, however UmiBam has additional functionality such as a double UMI feature or the option to allow mismatches in the UMI(s).</p>"},{"location":"bismark/deduplication/#deduplication-of-multiple-files-of-the-same-library","title":"Deduplication of multiple files of the same library","text":"<p>When using the option <code>--multiple</code>, all specified input files are treated as a single sample and concatenated together for deduplication. This uses Unix <code>cat</code> for SAM files and <code>samtools cat</code> for BAM files.</p> <p>Additional notes for BAM files: Although this works on either BAM or CRAM, all input files must be the same format as each other. The sequence dictionary of each input file must be identical, although this command does not check this. By default the header is taken from the first file to be concatenated.</p>"},{"location":"bismark/filter_nonconverted_reads/","title":"Filtering out non-bisulfite converted reads","text":"<p>Filtering incomplete bisulfite conversion from Bismark BAM files (optional). This script examines the methylation calls of reads, or read pairs for paired-end sequencing, and filters out reads that exceed a certain threshold of methylated calls in non-CG context (the default is 3). By default, <code>filter_non_conversion</code> looks for a certain number of methylated non-CG calls, but a percentage methylation cutoff may be specified alternatively.</p> <p>Please Note: Be aware that this kind of filtering is not advisable - and will introduce biases - if you work with organisms which exhibit any appreciable levels of non-CG methylation (e.g. most plants).</p> <p>Writes out a file called nonCG_filtered.bam, also a file called nonCG_removed_seqs.bam as well as a short report how many sequences have been analysed and removed.</p> <p>USAGE:</p> <pre><code>filter_non_conversion [options] [Bismark BAM files]\n</code></pre> <p>Please also note that for paired-end BAM files <code>filter_non_conversion</code> expects Read 1 and Read 2 to follow each other in consecutive lines! If the file has been sorted by position make sure that you resort it by read name first (e.g. using <code>samtools sort -n</code>)</p> <ul> <li><code>-s/--single</code></li> </ul> <p>Deduplicate single-end Bismark BAM files. If not specified the library type is auto-detected.</p> <ul> <li><code>-p/--paired</code></li> </ul> <p>Deduplicate paired-end Bismark BAM files. If not specified the library type is auto-detected.</p> <ul> <li><code>--threshold [int]</code></li> </ul> <p>The number of methylated cytosines in non-CG context at which reads or read pairs are filtered out. For paired-end files either Read 1 or Read 2 can fail the entire read pair. [Default: 3].</p> <ul> <li><code>--percentage_cutoff [int]</code></li> </ul> <p>Instead of filtering on an absolute count of methylated cytosines in non-CG context (see <code>--threshold [int]</code>) this option allows you to define an overall percentage of methylation in non-CG context (both CHH and CHG) which, if reached or exceeded, results in the read or read pair being filtered out. For paired-end files either Read 1 or Read 2 can fail the entire read pair. Also requires a minimum number of cytosines in non-CG context to make confident filtering choices (see <code>--minimum_count [int]</code>).</p> <ul> <li><code>--minimum_count [int]</code></li> </ul> <p>At least this number of cytosines in non-CG context (CHH or CHG) have to be seen in a read (irrespective of their methylation state) before the <code>--percentage_cutoff</code> filter kicks in. [Default: 5].</p> <ul> <li><code>--consecutive</code></li> </ul> <p>Non-CG methylation has to be found on consecutive non-CGs. Any kind of unmethylated cytosine (in any context) resets the methylated non-CG counter to 0. [Default: OFF].</p> <ul> <li><code>--samtools_path</code></li> </ul> <p>The path to your Samtools installation, e.g. /home/user/samtools/. Does not need to be specified explicitly if Samtools is in the PATH already.</p> <ul> <li><code>--help</code></li> </ul> <p>Displays this help text end exits.</p> <ul> <li><code>--version</code></li> </ul> <p>Displays version information and exits.</p> <p>If you get stuck at any point or have any questions or comments please contact me via e-mail: fkrueger@altoslabs.com</p>"},{"location":"bismark/genome_preparation/","title":"Genome preparation","text":"<p>This script needs to be run only once to prepare the genome of interest for bisulfite alignments. You need to specify a directory containing the genome you want to align your reads against (please be aware that the <code>bismark_genome_preparation</code> script expects <code>FastA</code> files in this folder (with either <code>.fa</code> or <code>.fasta</code> extension, single or multiple sequence entries per file). Bismark will create two individual folders within this directory, one for a C-&gt;T converted genome and the other one for the G-&gt;A converted genome. After creating C-&gt;T and G-&gt;A versions of the genome they will be indexed in parallel using the indexer <code>bowtie2-build</code> (or <code>hisat2-build</code>). Once both C-&gt;T and G-&gt;A genome indices have been created you do not need to use the genome preparation script again (unless you want to align against a different genome...).</p> <p>Again, please note that Bowtie 2 and HISAT2 indexes are not compatible! To create a genome index for use with HISAT2 the option <code>--hisat2</code> needs to be included as well.</p>"},{"location":"bismark/genome_preparation/#running-bismark_genome_preparation","title":"Running <code>bismark_genome_preparation</code>","text":"<p>USAGE: <code>bismark_genome_preparation [options] &lt;path_to_genome_folder&gt;</code></p> <p>A typical command could look like this:</p> <pre><code>bismark_genome_preparation --path_to_aligner /usr/bin/bowtie2/ --verbose /data/genomes/homo_sapiens/GRCh38/\n</code></pre>"},{"location":"bismark/library_types/","title":"Library types","text":"<p>Here is a table summarising general recommendations for different library types and/or different commercially available kits. Some more specific notes can be found below.</p> Technique 5' Trimming 3' Trimming Mapping Deduplication Extraction BS-Seq \u2b1c\ufe0f \u2b1c\ufe0f \u2b1c\ufe0f \u2705 <code>--ignore_r2 2</code> RRBS <code>--rrbs</code> (R2 only) <code>--rrbs</code> (R1 only) \u2b1c\ufe0f \u274c \u2b1c\ufe0f RRBS (NuGEN Ovation) special processing special processing \u2b1c\ufe0f \u274c <code>--ignore_r2 2</code> PBAT 6N / 9N (6N / 9N) <code>--pbat</code> \u2705 \u2b1c\ufe0f single-cell (scBS-Seq) 6N (6N) <code>--non_directional</code>; single-end mode \u2705 \u2b1c\ufe0f TruSeq (EpiGnome) 8 bp (8 bp) \u2b1c\ufe0f \u2705 \u2b1c\ufe0f Accel-NGS (Swift) R1: 10, R2:15bp (10 bp) \u2b1c\ufe0f \u2705 \u2b1c\ufe0f Zymo    Pico-Methyl 10 bp (10 bp) <code>--non_directional</code> \u2705 \u2b1c\ufe0f EM-seq (NEB) 10 bp 10 bp \u2b1c\ufe0f \u2705 \u2b1c\ufe0f <ul> <li>\u2b1c\ufe0f -   Default settings (nothing in particular is required, just use Trim Galore or Bismark default parameters)</li> <li>\u2705 -   Yes, please!</li> <li>\u274c -   No, absolutely not!</li> </ul> <p>5' Trimming can be accomplished with Trim Galore using:</p> <p><code>--clip_r1 &lt;NUMBER&gt;</code> (Read 1) or</p> <p><code>--clip_r2 &lt;NUMBER&gt;</code> (Read 2)</p> <p>3' Trimming can be accomplished with Trim Galore using:</p> <p><code>--three_prime_clip_r1 &lt;NUMBER&gt;</code> (Read 1) or</p> <p><code>--three_prime_clip_r2 &lt;NUMBER&gt;</code> (Read 2).</p>"},{"location":"bismark/library_types/#specific-library-kit-notes","title":"Specific library kit notes","text":""},{"location":"bismark/library_types/#rrbs","title":"RRBS","text":"<p>RRBS is a specialised technique to only look at CpG rich regions of the genome by using the restriction enzyme MspI (please see this RRBS Guide for some more specifics regarding data processing). For reasons explained in the RRBS-guide, the second last position of all reads before reading into the Illumina adapter exhibits an artificially (not methylated) methylation state as a result of the end-repair reaction. The option <code>--rrbs</code> within Trim Galore removes 2 extra bases whenever adapter contamination has been detected. This 3' end trimming that needs to be carried out for single-end runs or Read 1 of paired-end libraries. Read 2 of paired-end libraries is however not affected by this 3' bias, but instead the first couple of positions on the 5' end of Read 2 suffer from the read-through problem as Read 1 (Read 2 is a mere copy of Read 1), so Read 2 needs to have the first 2 bp removed instead. As of the current development version of Trim Galore (v0.4.2_dev; 12/16/2016) the option <code>--rrbs</code> removes:</p> <ul> <li>2 bp from the 3' end of single-end and Read 1 of paired-end reads in addition to adapter contamination, and</li> <li>2 bp from the 5' end of Read 2 of paired-end reads</li> </ul>"},{"location":"bismark/library_types/#rrbs-nugen-ovation-methyl-seq-system","title":"RRBS NuGEN Ovation Methyl-Seq System","text":"<p>(Manufacturer's page)</p> <p>Owing to the fact that the NuGEN Ovation kit attaches a varying number of nucleotides (0-3) after each MspI site Trim Galore should be run WITHOUT the option <code>--rrbs</code>. The trimming is accomplished in a subsequent diversity trimming step afterwards, please see the manufacturer's manual for more details.</p>"},{"location":"bismark/library_types/#pbat","title":"PBAT","text":"<p>The amount of bases that need to be trimmed from the 5' end depends on the length of the oligo used for random priming, which - as we know - isn't all that random, and in fact causes misalignments and methylation biases. While the original PBAT paper used 4N oligoes, these days 6N or 9N seem to be most common. Please also see the section 3' Trimming in general below.</p>"},{"location":"bismark/library_types/#single-cell","title":"Single-cell","text":"<p>The scBS-Seq method uses a PBAT-type protocol but employs five rounds of sequence capture and elongation to amplify the starting material so all four different bisulfite strands (OT, CTOT, OB, CTOB) are sequenced. Since 6N oligos are used to for the random priming step, 6 bp need to be removed from the 5' ends. Since scBS and PBAT libraries tend to result in chimaeric fragments we tend to treat scBS-Seq as single-end reads always. Please also see the section 3' Trimming in general below.</p>"},{"location":"bismark/library_types/#truseq-dna-methylation-kit-formerly-epignome","title":"TruSeq DNA-Methylation Kit (formerly EpiGnome)","text":"<p>(Manufacturer's page) This Illumina kit (previously known as EpiGnome kit from epicentre) also employs a post-bisulfite strategy using 6N oligos, but in contrast to the PBAT technique only the standard original top and bottom strands (OT and OB) are sequenced, meaning that Bismark can be run in default (= directional) mode. Even though the random priming is performed with 6N oligoes we often saw that the methylation bias extends to 7 or 8 bp, so trimming 8 bp off the 5' end(s) is recommended initially. Please do have a look at the M-bias plots nevertheless to see of more bases need removing/ignoring during the methylation extraction process. Please also see the section 3' Trimming in general below.</p>"},{"location":"bismark/library_types/#zymo-pico-methyl-seq","title":"Zymo Pico Methyl-Seq","text":"<p>(Manufacturer's page) The Pico Methyl-Seq kit also uses a random priming step similar to the PBAT // single-cell methods above. This kit uses random tetramers (4N) for the amplification step, however the biases seen in the base composition and M-bias plots indicate that one should trim off at least the first 10 bp from each read. This kit performs three rounds of amplification which yields non-directional libraries (similar to the scBS-Seq protocol), so all four different bisulfite strands (OT, CTOT, OB, CTOB) are present in the library. According to the manufacturer, the library construction is designed for a starting input material of 100 ng, but can be scaled up or down (to 100 pg). Please also see the section 3' Trimming in general below.</p>"},{"location":"bismark/library_types/#swift","title":"Swift","text":"<p>Manufacturer's page The Accel-NGS Methyl-Seq protocol uses Adaptase technology for capturing single-stranded DNA in an unbiased (again, not that unbiased actually...) manner. Also here, the first ~10-15 bp show extreme biases in sequence composition and M-bias, so trimming off at least 10 bp is advisable (please check the M-bias plot if even more is needed). Please also see the section 3' Trimming in general below.</p>"},{"location":"bismark/library_types/#em-seq-neb","title":"EM-seq (NEB)","text":"<p>EM-seq protocol. The Enzymatic Methyl-seq (EM-seq) protocol uses different enzymes to detect 5mC and 5hmC in a non-bisulfite dependent manner that allows capturing longer fragments and working with very low levels of starting material (EM-seq paper). NEB internally don't trim more than 5bp from each read, but as discussed in this thread, the recommended conservative trimming parameters are:</p> <pre><code>--clip_R1 10 --clip_R2 10 --three_prime_clip_R1 10 --three_prime_clip_R2 10\n</code></pre>"},{"location":"bismark/library_types/#random-priming-and-3-trimming-in-general","title":"Random priming and 3' Trimming in general","text":"<p>As we have seen before, the random priming of post-bisulfite methods (such as PBAT, scBS-Seq, EpiGnome, Pico Methyl, Accel etc.) introduces errors, indels and methylation biases that may detrimentally affect your mapping efficiencies and methylation calls. These problems are fairly easy to spot at the 5' ends of reads because all reads will equally suffer from the problems at the same positions at the start (5' end) of reads. The same problems of random priming (indels, mispriming) will however most likely occur on both sides of the fragment to be sequenced, but it is doubtful that one would be able to spot these problems on the 3' end of reads because the problems would be expected on the 3' end of reads just before reading through into the adapter, and this may occur</p> <ul> <li>at different positions in the read (depending on how short the fragment was)</li> <li>at different positions within the read because of quality trimming in addition to adapter read-through contamination</li> <li>not at all within the read length (whenever a fragment is longer than the sequenced read length)</li> <li>at the 3' end even without hitting the adapter (i.e. just before the adapter)</li> </ul> <p>I guess there is a trade-off between accepting that a certain proportion of the reads may have a few biased biased positions towards their 5' ends, and preemptively trimming the 3' end by the same amount of bases as the 5' end. As a general rule it is probably safe to say that the shorter the average insert size of a library - the more of a problem the bias is. We have e.g. seen Pico Methyl libraries where ~80% of all fragments were shorter than 100bp, so a 2x125bp run would most likely be affected by the random priming bias on the 5' and 3' ends in nearly all fragments sequenced. We realise that trimming off say 10 bp from the 5' end and 3' end of a 100 bp read already removes 20% of the actually sequenced data, but this is the price you have to pay for using post-bisulfite kits...</p> <p>For these reasons we have put the 3' Trimming values in the table above in (parentheses) as a reminder that you should perform 3' trimming of the data as well.</p>"},{"location":"bismark/methylation_extraction/","title":"Methylation extraction","text":"<p>Bismark comes with a supplementary <code>bismark_methylation_extractor</code> script which operates on Bismark result files and extracts the methylation call for every single C analysed. The position of every single C will be written out to a new output file, depending on its context (CpG, CHG or CHH), whereby methylated Cs will be labelled as forward reads (+), non-methylated Cs as reverse reads (-). The resulting files can be imported into a genome viewer such as SeqMonk (using the generic text import filter) and the analysis of methylation data can commence. Alternatively, the output of the methylation extractor can be transformed into a <code>bedGraph</code> and <code>coverage</code> file using the option <code>--bedGraph</code> (see also <code>--counts</code>). This step can also be accomplished from the methylation extractor output using the stand-alone script <code>bismark2bedGraph</code> (also part of the Bismark package available for download at bioinformatics.babraham.ac.uk). The <code>coverage</code> file can also be imported into SeqMonk directly using <code>Import Data &gt; Bismark (cov)</code>. Optionally, the bedGraph counts output can be used to generate a genome-wide cytosine report which reports the number on every single CpG (optionally every single cytosine) in the genome, irrespective of whether it was covered by any reads or not. As this type of report is informative for cytosines on both strands the output may be fairly large (~46mn CpG positions or &gt;1.2bn total cytosine positions in the human genome...). The bedGraph to genome-wide cytosine report conversion can also be run individually using the stand- alone module <code>coverage2cytosine</code> (also part of the Bismark package available for download at bioinformatics.babraham.ac.uk).</p> <p>As of Bismark version 0.6 or higher the default input format for the <code>bismark_methylation_extractor</code> is BAM/SAM (or potentially CRAM if you\u2019ve got Samtools 1.2+ installed).</p>"},{"location":"bismark/methylation_extraction/#the-methylation-extractor-output-looks-like-this-tab-separated","title":"The methylation extractor output looks like this (tab separated):","text":"<ol> <li>seq-ID</li> <li>methylation state</li> <li>chromosome</li> <li>start position (= end position)</li> <li>methylation call</li> </ol> <p>Methylated cytosines receive a <code>+</code> orientation, unmethylated cytosines receive a <code>-</code> orientation.</p> <p>Examples for cytosines in CpG context:</p> <pre><code>HWUSI-EAS611_0006:3:1:1058:15806#0/1 - 6 91793279 z\nHWUSI-EAS611_0006:3:1:1058:17564#0/1 + 8 122855484 Z\n</code></pre> <p>Examples for cytosines in CHG context:</p> <pre><code>HWUSI-EAS611_0006:3:1:1054:1405#0/1 - 7 89920171 x\nHWUSI-EAS611_0006:3:1:1054:1405#0/1 + 7 89920172 X\n</code></pre> <p>Examples for cytosines in CHH context:</p> <pre><code>HWUSI-EAS611_0006:3:1:1054:1405#0/1 - 7 89920184 h\n</code></pre> <p>The <code>bismark_methylation_extractor</code> comes with a few options, such as ignoring the first  number of positions in the methylation call string, e.g. to remove a restriction enzyme site (if RRBS is performed with non-directional BS-Seq libraries it might be required to remove reconstituted MspI sites at the beginning of each read as they will introduce a bias into the first methylation call). Another useful option for paired-end reads is called <code>--no_overlap</code> (on by default): specifying this option will extract the methylation calls of overlapping parts in the middle of paired-end reads only once (using the calls from the first read which is presumably the one with a lowest error rate). <p>For a full list of options type: <code>bismark_methylation_extractor --help</code> on the command line or refer to the Appendix section at the end of this User Guide.</p>"},{"location":"bismark/methylation_extraction/#methylation-extractor-output","title":"Methylation extractor output","text":"<p>By default, the <code>bismark_methylation_extractor</code> discriminates between cytosines in CpG, CHG or CHH context. If desired, CHG and CHH contexts can be merged into a single non-CpG context by specifying the option <code>--merge_non_CpG</code> (as a word of warning, this might produce files with up to several hundred million lines...).</p>"},{"location":"bismark/methylation_extraction/#strand-specific-methylation-output-files-default","title":"Strand-specific methylation output files (default):","text":"<p>As its default option, the <code>bismark_methylation_extractor</code> will produce a strand-specific output which will use the following abbreviations in the output file name to indicate the strand the alignment came from:</p> <pre><code>OT    \u2013  original top strand\nCTOT  \u2013  complementary to original top strand\nOB    \u2013  original bottom strand\nCTOB  \u2013  complementary to original bottom strand\n</code></pre> <p>Methylation calls from OT and CTOT will be informative for cytosine methylation positions on the original top strand, calls from OB and CTOB will be informative for cytosine methylation positions on the original bottom strand. Please note that specifying the <code>--directional</code> (the default mode) option in the Bismark alignment step will not report any alignments to the CTOT or CTOB strands.</p> <p>As cytosines can exist in any of three different sequence contexts (CpG, CHG or CHH) the <code>bismark_methylation_extractor</code> default output will consist of 12 individual output files per input file (<code>CpG_OT_...</code>, <code>CpG_CTOT_...</code>, <code>CpG_OB_...</code> etc.).</p>"},{"location":"bismark/methylation_extraction/#context-dependent-methylation-output-files-comprehensive-option","title":"Context-dependent methylation output files (<code>--comprehensive</code> option):","text":"<p>If strand-specific methylation is not of interest, all available methylation information can be pooled into a single context-dependent file (information from any of the four strands will be pooled). This will default to three output files (CpG-context, CHG-context and CHH-context), or result in 2 output files (CpG-context and Non-CpG-context) if <code>--merge_non_CpG</code> was selected (note that this can result in enormous file sizes for the non-CpG output).</p> <p>Both strand-specific and context-dependent options can be combined with the <code>--merge_non_CpG</code> option.</p>"},{"location":"bismark/methylation_extraction/#optional-bedgraph-output","title":"Optional bedGraph output","text":"<p>The Bismark methylation extractor can optionally also output a file in <code>bedGraph</code> format which uses 0-based genomic start and 1- based end coordinates. The module <code>bismark2bedGraph</code> (part of the Bismark package) may also be run individually. It will be sorted by chromosomal coordinates and looks like this:</p> <pre><code>&lt;chromosome&gt; &lt;start position&gt; &lt;end position&gt; &lt;methylation percentage&gt;\n</code></pre> <p>As the methylation percentage is per se not informative of the actual read coverage of detected methylated or unmethylated reads at a position, <code>bismark2bedGraph</code> also writes out a coverage file (using 1-based genomic genomic coordinates) that features two additional columns:</p> <pre><code>&lt;chromosome&gt; &lt;start position&gt; &lt;end position&gt; &lt;methylation percentage&gt; &lt;count methylated&gt; &lt;count unmethylated&gt;\n</code></pre> <p>These two additional columns enable basically any downstream processing from the file. By default, this mode will only consider cytosines in CpG context, but it can be extended to cytosines in any sequence context by using the option <code>--CX</code> (cf. Appendix (III)).</p>"},{"location":"bismark/methylation_extraction/#optional-genome-wide-cytosine-report-output","title":"(Optional): genome-wide cytosine report output","text":"<p>Starting from the <code>coverage</code> output, the Bismark methylation extractor can optionally also output a genome-wide cytosine methylation report. The module <code>coverage2cytosine</code> (part of the Bismark package) may also be run individually. It is also sorted by chromosomal coordinates but also contains the sequence context and is in the following format:</p> <pre><code>&lt;chromosome&gt; &lt;position&gt; &lt;strand&gt; &lt;count methylated&gt; &lt;count unmethylated&gt; &lt;C-context&gt; &lt;trinucleotide context&gt;\n</code></pre> <p>The main difference to the <code>bedGraph</code> or <code>coverage</code> output is that every cytosine on both the top and bottom strands will be considered irrespective of whether they were actually covered by any reads in the experiment or not. For this to work one has to also specify the genome that was used for the <code>Bismark</code> alignments using the option <code>--genome_folder &lt;path&gt;</code>. As for the <code>bedGraph</code> mode, this will only consider cytosines in CpG context by default but can be extended to cytosines in any sequence context by using the option <code>--CX</code> (cf. Appendix (III)). Be aware though that this might mean an output with individual lines for more than 1.1 billion cytosines for any large mammalian genome...</p>"},{"location":"bismark/methylation_extraction/#gpc-methylation-assessment-context-specific-methylation-summary-report","title":"GpC methylation assessment: Context-specific methylation summary report","text":"<p>Every time <code>coverage2cytosine</code> is run, the counts for each cytosine context are recorded and printed to a special file called <code>*.cytosine_context_summary.txt</code> for each input coverage file. </p> <p>The report (introduced here) looks at 2 bp downstream, as well as 1 bp upstream of the cytosine taking part in the methylation call. This is useful for looking at methylation in specific contexts (e.g. <code>CpA</code> only), and also when using <code>GpC</code> methylases that introduce methylation in <code>GpC</code> context. The report looks like this: </p> <pre><code>upstream    C-context   full context    count methylated    count unmethylated  percent methylation\nA   CAA ACAA    308398  93360   23.24\nC   CAA CCAA    329555  75518   18.64\nG   CAA GCAA    242262  118175  32.79\nT   CAA TCAA    302209  86219   22.20\nA   CAC ACAC    266786  91121   25.46\nC   CAC CCAC    409749  89154   17.87\n...\n</code></pre>"},{"location":"bismark/methylation_extraction/#optional-nome-seq-or-scnmt-seq","title":"(Optional): NOMe-seq or scNMT-seq","text":"<p>The <code>coverage2cytosine</code> module can be instructed that a sample is a NOMe-seq (Nucleosome Occupancy and Methylome sequencing) or scNMT-seq (single-cell Nucleosome, Methylation and Transcription sequencing) sample, where accessible DNA gets methylated in a GpC context (sets option <code>--gc</code> as well). The option <code>--nome-seq</code>:</p> <pre><code> (i) filters the genome-wide CpG-report to only output cytosines in ACG and TCG context\n(ii) filters the GC context output to only report cytosines in GCA, GCC and GCT context\n</code></pre> <p>Both of these measures aim to reduce unwanted biases, i.e. the influence of <code>G-CG</code> (intended) and <code>C-CG</code> (off-target) on endogenous CpG methylation, and the influence of CpG methylation on (the NOMe-seq specific) <code>GC</code> context methylation. PLEASE NOTE that NOMe-seq data requires a <code>.cov.gz</code> file as input which has been generated in non-CG mode!! (<code>--CX</code>), else the <code>GpC</code> output file will be empty...</p>"},{"location":"bismark/methylation_extraction/#m-bias-plot","title":"M-bias plot","text":"<p>Starting with Bismark v0.8.0, the Bismark methylation extractor also produces a methylation bias plot which shows the methylation proportion across each possible position in the read (described in further detail in: Hansen et al., Genome Biology, 2012, 13:R83). The data for the M-bias plot is also written into a coverage text file (ending in <code>.cov</code> or <code>.cov.gz</code>) and is in the following format:</p> <pre><code>&lt;read position&gt; &lt;count methylated&gt; &lt;count unmethylated&gt; &lt;% methylation&gt; &lt;total coverage&gt;\n</code></pre> <p>This allows generating nice graphs by alternative means, e.g. using R or Excel. The plot is also drawn into a .png file which requires the Perl module GD::Graph (more specifically, both modules GD::Graph::lines and GD::Graph::colour are required); if GD::Graph cannot be found on the system, only the table will be printed. The plot also contains the absolute number of methylation calls (both methylated and unmethylated) per position. For paired-end reads two individual M-bias plots will be drawn.</p> <p>The M-bias plot can for example show the methylation bias at the start of reads in PBAT-Seq experiments:</p> <p></p> <p>For more on this topic please also see this post on QCFail.com.</p> <p>Or it can reveal a 3\u2019-end-repair bias at the first couple of positions in read 2 of paired-end reads, like here:</p> <p></p> <p>For more on this topic please also see this post on QCFail.com.</p> <p>The M-bias plot should enable researchers to make an informed decision whether or not to leave the bias in the final data or to remove it (e.g. using the methylation extractor option <code>--ignore</code>).</p>"},{"location":"bismark/methylation_extraction/#iii-running-bismark_methylation_extractor","title":"(III) Running <code>bismark_methylation_extractor</code>","text":"<p>USAGE: <code>bismark_methylation_extractor [options] &lt;filenames&gt;</code></p> <p>A typical command for a single-end file could look like this:</p> <pre><code>bismark_methylation_extractor --gzip sample_bismark_bt2.bam\n</code></pre> <p>A typical command for a paired-end file could look like this:</p> <pre><code>bismark_methylation_extractor --gzip sample_bismark_bt2_pe.bam\n</code></pre> <p>The methylation extractor can also auto-detect the alignment mode and will set the options above automatically. A typical command including the optional <code>bedGraph</code> output could look like this:</p> <pre><code>bismark_methylation_extractor --gzip --bedGraph --buffer_size 10G sample_bismark_bt2.bam\n</code></pre> <p>A typical command including the optional genome-wide cytosine methylation report could look like this:</p> <pre><code>bismark_methylation_extractor --gzip --bedGraph --buffer_size 10G --cytosine_report --genome_folder /path_to_genome_folder/ sample_bismark_bt2.bam\n</code></pre>"},{"location":"bismark/processing_report/","title":"Processing report","text":"<p>The script <code>bismark2report</code> uses a Bismark alignment report, and optionally further reports of the Bismark suite such as deduplication, methylation extractor (splitting) or M-bias reports to generate a graphical HTML report page.</p> <p>If several Bismark reports are found in the same folder, a separate report will be generated for each of these, whereby the output filename is derived from the Bismark alignment report file.</p> <p><code>bismark2report</code> attempts to find optional reports automatically based on the file basename.</p> <p>Example reports</p> <p>You can see an example single-end report and paired-end report.</p>"},{"location":"bismark/processing_report/#usage","title":"Usage","text":"<pre><code>bismark2report [options]\n</code></pre>"},{"location":"bismark/processing_report/#options","title":"Options","text":"<ul> <li><code>-o/--output &lt;filename&gt;</code> (optional)</li> </ul> <p>Name of the output file. If not specified explicitly, the output filename will be derived from the Bismark alignment report file. Specifying an output filename only works if the HTML report is to be generated for a single Bismark alignment report (and potentially additional reports).</p> <ul> <li><code>--dir &lt;directory&gt;</code> (optional)</li> </ul> <p>Output directory. Default: current directory.</p> <ul> <li><code>--alignment_report FILE</code> (optional)</li> </ul> <p>If not specified, <code>bismark2report</code> attempts to find Bismark report file(s) in the current directory and produces a separate HTML report for each mapping report file. Based on the basename of the Bismark mapping report, <code>bismark2report</code> will also attempt to find the other Bismark reports (see below) for inclusion into the HTML report.</p> <p>Note</p> <p>Although the option is optional (as bismark can try to detect the filename automatically), including a Bismark alignment report file is mandatory.</p> <ul> <li><code>--dedup_report FILE</code> (optional)</li> </ul> <p>If not specified, <code>bismark2report</code> attempts to find a deduplication report file with the same basename as the Bismark mapping report (generated by <code>deduplicate_bismark</code>) in the current working directory.</p> <p>Including a deduplication report is optional, and using the FILE <code>none</code> will skip this step entirely.</p> <ul> <li><code>--splitting_report FILE</code> (optional)</li> </ul> <p>If not specified, <code>bismark2report</code> attempts to find a splitting report file with the same basename as the Bismark mapping report (generated by the Bismark methylation extractor) in the current working directory.</p> <p>Including a splitting report is optional, and using the FILE <code>none</code> will skip this step entirely.</p> <ul> <li><code>--mbias_report FILE</code> (optional)</li> </ul> <p>If not specified, <code>bismark2report</code> attempts to find a single M-bias report file with the same basename as the Bismark mapping report (generated by the Bismark methylation extractor) in the current working directory.</p> <p>Including an M-Bias report is optional, and using the FILE <code>none</code> will skip this step entirely.</p> <ul> <li><code>--nucleotide_report FILE</code> (optional)</li> </ul> <p>If not specified, <code>bismark2report</code> attempts to find a single nucleotide coverage report file with the same basename as the Bismark mapping report (generated by Bismark with the option <code>--nucleotide_coverage</code>, or <code>bam2nuc</code> directly) in the current working directory.</p> <p>Including a nucleotide coverage statistics report is optional, and using the FILE <code>none</code> will skip this report entirely.</p>"},{"location":"bismark/summary_report/","title":"Summary report","text":"<p>This script uses Bismark report files of several (up to hundreds of!?) samples in a run folder to generate a graphical summary HTML report as well as a whopping big table (tab-delimited text) with all relevant alignment and methylation statistics which may be used for graphing purposes in R, Excel or the like.</p> <p>Unless certain BAM files are specified, <code>bismark2summary</code> first identifies Bismark BAM files in a folder (they need to use the Bismark naming conventions) and then automatically detects Bismark alignment, deduplication or methylation extractor (splitting) reports based on the input file basename.</p> <p>If splitting reports are found they overwrite the methylation statistics of the initial alignment report.</p> <p>Example report</p> <p>You can see an example Bismark Summary Report here.</p> <p>Tip</p> <p>The Bismark summary report is meant to give you a quick visual overview of the alignment statistics for a large number of samples (tens, hundreds or thousands of samples).</p> <p>If you only want to look at a single report please check out the <code>bismark2report</code>.</p>"},{"location":"bismark/summary_report/#usage","title":"Usage","text":"<pre><code>bismark2summary [options]\n</code></pre> <p>This command scans the current working directory for different Bismark alignment, deduplication and methylation extraction (splitting) reports to produce a graphical summary HTML report, as well as a data table, for all files in a directory.</p>"},{"location":"bismark/summary_report/#arguments","title":"Arguments","text":"<ul> <li><code>&lt;BAM filename(s)&gt;</code> (optional)</li> </ul> <p>If no BAM filenames are specified, the current working directory is scanned for Bismark alignment files and their associated reports.</p> <p>Tip</p> <p>Note that the actual files are not needed, just filenames. These are used to deduce the report filenames.</p>"},{"location":"bismark/summary_report/#options","title":"Options","text":"<ul> <li><code>-o/--basename &lt;filename&gt;</code> (optional)</li> </ul> <p>Basename of the output file. Generate a text file with all relevant extracted values <code>&lt;basename&gt;.txt</code>) as well as an HTML report (<code>&lt;basename&gt;.html</code>). If not specified explicitly, the basename is <code>bismark_summary_report</code>.</p> <ul> <li><code>--title &lt;string&gt;</code> (optional)</li> </ul> <p>HTML report title. Default: 'Bismark Summary Report'.</p> <p>Note</p> <p>Remember to use quotes if using spaces: <code>--title \"speech marks for text with spaces\"</code></p> <ul> <li><code>--version</code></li> </ul> <p>Displays version information and exits.</p> <ul> <li><code>--help</code></li> </ul> <p>Displays this help message and exits.</p>"},{"location":"faq/","title":"Bismark FAQs","text":"<p>This will be a collection of fairly common issues that arise fairly regularly. Started on 03 Sept 2019</p> <ul> <li>Single-cell and PBAT libraries</li> <li>Low mapping efficiency of paired-end libraries</li> <li>Context change between coverage and cytosine reports</li> <li>Bisulfite conversion efficiency</li> </ul>"},{"location":"faq/context_change/","title":"Context change","text":""},{"location":"faq/context_change/#context-changediscrepancy-between-bismark-coverage-and-genome-wide-cytosine-reports","title":"Context change/discrepancy between Bismark coverage and genome-wide cytosine reports","text":"<p>A question that comes up every so often is: \"Why do some positions have a different cytosine context between the coverage and genome-wide cytosine reports produced by <code>coverage2cytosine</code>? In rare(r) cases, the same position can even be present in several different contexts - how is this possible?\"</p> <p>Answer:</p> <p>The Bismark coverage files contain every position that received a methylation call during the mapping step. There are certain cases where the cytosine context may change due to a deletion in the immediate downstream proximity of the cytosine, like in the following example:</p> <p><code>CAATGGGA</code> Here, the first C is in CHH context. If there was a deletion of AAT, one would would get an alignment like this:</p> <p><code>C---GGGA</code> here the context would effectively have changed from CHH to CG.</p> <p>At least for mammalian systems it is quite likely that such a change would also affect the methylation state of the cytosine involved because CpGs are typically methylated whereas non-CG cytosines are largely completely unmethylated.</p> <p>This context change only ever occurs for deletions immediate downstream of a cytosine, but not insertions. The reason for this is that insertions are padded with <code>X</code> during the methylation call procedure, which would render the cytosine context <code>Unknown</code>.</p> <p><code>coverage2cytosine</code> on the other hand is fully reference genome-based, so it will go through the reference sequence and check whether a cytosine was covered or not. The sequence context is purely assigned based on the reference sequence.</p> <ul> <li> <p>For CpG context only (the default), it will therefore \u2018miss\u2019 out any of the calls where a deletion had changed the sequence   context from <code>CpG</code> to either <code>CHG</code> or <code>CHH</code>.</p> </li> <li> <p>In <code>--CX</code> context: One may encounter cases where the context of a cytosine has changed, or much more rarely, where the very same position   may have been called with different cytosine contexts in the intitial CHG, CHH and CpG-context files produced by the <code>bismark_methylation_extractor</code>.   If now, howevever, <code>--CX</code> was used for <code>bismark2bedGraph</code>   and <code>coverage2cytosine</code> (or directly during the <code>bismark_methylation_extractor</code> step), those different cytosine contexts will be merged   again for that position, and will get the cytosine context assigned purely based on the reference sequence. In other words: If there truly   was a cytosine context - that may or may not affect the methylation state - it would be, probably erroneously, attributed to the context   provided by the reference sequence.</p> </li> </ul>"},{"location":"faq/context_change/#in-a-nutshell","title":"In a nutshell:","text":"<p>By design, Bismark generally bases its methylation call behavior on the reference genome, with the rationale being that sequencing errors occur much more frequently than true polymorphisms in the genome sequence. The sequence context of insertions would be dependent on the basecall accuracy of the inserted base(s), so we chose to call these methylation calls in <code>Unknown</code> context. Deletions on the other hand are a very rare error in Illumina data, and we believe it should be fine to proceed with the default behavior of calling changed sequence context because it is very likely that a change from CHH to CpG context, or vice versa, will really also lead to a change in that residue's methylation state.</p> <p>If you work with coverage files in <code>CpG</code> context only you may miss a few positions that should be CpG positions according to the reference sequence. On the other hand it may also contain a few newly gained CpGs positions that had a different context (<code>CHG</code> or <code>CHH</code>) in the reference sequence but where the read sequence says otherwise.</p> <p>If you are working in <code>--CX</code> mode, or with the genome-wide report (or both), I am afraid it is a little more complicated...</p>"},{"location":"faq/conversion_efficiency/","title":"Conversion efficiency","text":""},{"location":"faq/conversion_efficiency/#bisulfite-conversion-rate-considerations","title":"Bisulfite conversion rate - Considerations","text":"<p>The methylation state of cytosines which were called as methylated is generally a mix of at least three factors:</p> <ul> <li>genuine methylation</li> <li>bisulfite non-conversion</li> <li>mis-mapping events (which tend to result in random, garbage methylation calls)</li> </ul> <p>Generally, the bisulfite conversion of unmethylated cytosine residues should be as complete as possible, so that any cytosine that is found non-converted can be assumed to be really methylated. However, if the bisulfite conversion was for whatever reason not very efficient (e.g. wrong temperature, incubation time too short, wrong salt concentrations, etc.) one has to expect spurious methylation calls, and hence noise in your results.</p> <p>If the bisulfite coversion rate is found to be quite high, one might opt to repeat the experiment altogether (if that is possible at all) rather than dealing with potentially quite noisy data. If repeating the experiment is not an option, you are frankly somewhat limited with what you can do downstream to alleviate the problem. You could try to identify and remove reads that completely 'evaded' conversion using <code>methylation_consistency</code>, or bear the non-conversion value in mind when interpreting the data. Simply subtracting the conversion error from the results doesn't seem to be a great option, as in our experience different contexts are affected differently (CpG methylation seems to be less affected than non-CG content, probably because it tends to have more methylation generally?)</p> <p>To judge the bisulfite conversion rate and gauge whether this is likely a factor that has to be taken into consideration, one has several options:</p> <p>Look for lowest methylation genome-wide in non-CG context</p> <p>If you don't have any spike-in controls (see below), one could simply look at the lowest methylation levels you see anywhere in your experiment. In mammalian systems, where the rate of methylation in non-CG context is often very low (*), it may be enough to just look at the methylation levels in non-CG context. As an example, if you see a general methylation of 0.3% in non-CG context over many millions of methylation calls, then the bisulfite conversion must have been at least 99.7% efficient.</p> <p>*) A value of 0.3% methylation in non-CG context does not necessarily mean that this is the exact number of methylated cytosines that did not get converted, see above (it may have been 99.95% efficient for all we know...), but it certainly can't have been any worse....</p> <p>Other organisms, such as plants, may display elevated and different levels of methylation in non-CG context, so judging the conversion efficiency in this way may not be possible.</p> <p>Look for lowest methylation genome-wide elsewhere</p> <p>It may also be possible to look at more specific regions of the genome to find the lowest methylation possible. This could be CpG islands (which tend be be lowly methylated even in CpG context), the mitochondria (chrMT/chrM), or in plants reads aligned to the chloroplast sequence (which should not be methylated either). Whether mitochondria can be regarded as completely unmethylated or displaying some forms of methylation is probably still debatable... On top of this there could be tertiary structures or other conversion artefacts preventing some residues from getting bisulfite converted, as has been nicely demonstrated for the methylation of mitochondria.</p> <p>Spike-in controls</p> <p>Some experimentalists choose to add spike-in controls into their experiment to measure the rate of (non-)conversion in their experiment. This may include unmethylated (e.g. Lambda, phiX, M13) or methylated controls (e.g. in-vitro methylated pUC19), or even oligonucleotides with known methylation states.</p> <p>These spike-in controls do normally not align to any other genome, so one can index a spike-in genome and run a separate alignment to the spike-in genome in addition to the alignment against your genome of interest (without having to worry about cross-mapping artefacts).</p> <p>Instead of running two consecutive rounds of alignments, one to the genome of interest and then second one against the spike-in sequence, another possibility would be to include the spike-in sequence as an additional 'chromosome' to the genome of interest, and then carry our the genome indexing once more. In this way you should be able to get both genomic alignments and conversion rates in a single step.</p> <p>This is not to say that the spike-in sequences will always be a useful control, almost more often than not the spike-ins seem to behave in a slightly weird way, e.g. the conversion efficiencies appear to be (slighlty) worse than what one sees for methylation in non-CG context of the genome of interest. In the end, one can often only take the values of the spike-in controls with a pinch of salt, acknowledge them - and move on regardless :)</p>"},{"location":"faq/low_mapping/","title":"Low mapping","text":""},{"location":"faq/low_mapping/#low-mapping-effiency-of-paired-end-bisulfite-seq-sample","title":"Low mapping effiency of paired-end bisulfite-seq sample","text":"<p>This is a question that pops up every so often, and might have been discussed in numerous issues on Github or at seqanswers.com.</p> <p>Here are some suggestions what you might want to try out:</p> <ul> <li> <p>Run adapter and quality trimming. Usually, a standard run through Trim Galore will do the trick</p> </li> <li> <p>Perform a multi-genome alignment (e.g. using FastQ Screen (in <code>--bisulfite</code> mode!)). The \"usual suspect\" genomes should include PhiX, Lamda (or other spike-ins), as well as genomes that are typically handled in your lab/sequencing facility (don't forget to add the human genome!).</p> </li> <li> <p>Align the data in single-end mode. R1 typically needs to be aliged in default (=directional) mode, and R2 required <code>--pbat</code> to align. This will give you an indication if either R1 or R2 on its own aligns well, and if it is the paired-end nature of the data that is impairing high mapping efficiencies.</p> </li> <li> <p>Relaxing the alignment stringency. The easiest way to accomolish this is to change the <code>--score_min</code> function, e.g from <code>--score_min L,0,-0.2</code> (the default) to <code>--score_min L,0,-0.6</code>. This might be useful for alignments against genomes which are not as polished as the human or mouse genomes, and might give you an indication whether the number of mismatches and/or indels has a detrimental impact on the alignment efficiency. Keep in mind though that laxer mapping parameters may take a longer time to align, and potentially return more ambiguous (and at some point incorrect alignments).</p> </li> <li> <p>Bisulfite libraries typcially contain fairly short fragments (compared to standard DNA libraries), with fragment sizes often peaking between 80 and 120bp in length. Very occasionally, library prepr protocols inlude longer fragments (longer than the default cutoff of 500bp). To test whether this is the case, you can temporarily increase the maximum fragment length to e.g. <code>-X 1000</code> (if this doesn't help then go back down to the default as increasing <code>-X</code> increases the alignment time.</p> </li> <li> <p>As a last resort to relaxing the mapping stringency, try to use <code>--local</code> mode. This comes with a number of caveats, but it might assist in determining whether or not there is usable sequence present in the library.</p> </li> <li> <p>Did you use a special library preparation technique, or an exotic commercial kit? Please see our trimming and alignment recommendations here</p> </li> <li> <p>Look at sequence composition plots in FastQC. Is there anything unusual/unexpected that might prevent alignments?</p> </li> </ul> <p>If you still have any questions, feel free to send me an email with your issues. You might want to attach ~200K raw FastQ reads (compressed withy <code>gzip</code>) and mention the genome of interest in your email.</p>"},{"location":"faq/single_cell_pbat/","title":"Single cell PBAT","text":""},{"location":"faq/single_cell_pbat/#thoughts-and-considerations-regarding-single-cell-and-pbat-libraries-september-18-2019","title":"Thoughts and considerations regarding single-cell and PBAT libraries (September 18, 2019).","text":"<p>Bisulfite sequencing based on post-bisulfite adapter tagging (PBAT), including scBS-seq (single-cell Bisulfite-Seq) or scNMT-seq (single-cell nucleosome, methylation and transcription sequencing) often suffers from a number of 'issues' that one should keep in mind when processing the data:</p> <ul> <li>Special alignment mode</li> </ul> <p>PBAT libraries pull down strands of DNA that are complementary to the 'usual' DNA strands (OT and OB), and therefore normally require mapping in <code>--pbat</code> mode to the complementary strands (CTOT and CTOB). Single-cell techniques on the other hand undergo several rounds of DNA amplification after the bisulfite conversion step, which means they have to be aligned in <code>--non_directional</code> mode.</p> <ul> <li>Mis-priming</li> </ul> <p>PBAT/ single-cell libraries typically have a very biased sequence composition at the 5' end of reads which reflects the non-randomness of the priming/ pull-down process. The symptoms and possible mitigation procedures have already been discussed in more detail here: QCFail mis-priming issues. In conclusion, reads should be hard-trimmed from their 5'-ends before doing the alignments to prevent lower mapping effiency and mis-mapping/mis-calling methylation states. See also our trimming and processing notes for various library strategies in the Bismark Manual.</p> <ul> <li>Chimeric reads</li> </ul> <p>The presence of chimeric reads has previously been discussed in more detail over at QCFail. Hybrid reads in this context are reads that would be considered discordant, i.e. where R1 and R2 align to completely different places in the genome, or where only one read aligns well but the other one doesn't.</p> <p>Expanding on this idea, a recent article in Bioinformatics also demonstrated that chimeric reads are the main problem for the low mapping efficiency in scBS-seq. In their article, Wu and colleagues demonstrate that the post-bisulfite based library construction protocol leads to a substantial amount of chimeric molecules as a result of recombination of genomic proximal sequences with \u2018microhomology regions (MR)\u2019. As a means to combat this problem the authors suggest a method that uses local alignments of reads that do not align in a traditional manner, and in addition remove MR sequences from these local alignments as they can introduce noise into the methylation data.</p>"},{"location":"faq/single_cell_pbat/#mapping-strategies-for-paired-end-data","title":"Mapping strategies for paired-end data","text":""},{"location":"faq/single_cell_pbat/#pbat","title":"PBAT","text":"<p>To rescue as much data from a paired-end PBAT library with low mapping efficiency as possible we sometimes perform the following method (affectionately termed \u201cDirty Harry\u201d because it is not the most straight forward or cleanest approach):</p> <ul> <li> <p>We would recommend running 5\u2032 clipping and trimming first (e.g. <code>trim_galore --clip_r1 6 --clip_r2 6 --paired *fastq.gz</code>, and run Bismark in paired-end mode with <code>--unmapped</code> specified</p> </li> <li> <p>Properly aligned PE reads should be methylation extracted while counting overlapping reads only once (which is the default)</p> </li> <li>unmapped R1 is then mapped in single-end mode (<code>--pbat</code>)</li> <li>unmapped R2 is then mapped in single-end mode (in default = directional mode)</li> </ul> <p>Single-end aligned R1 and R2 can then be methylation extracted normally as they should in theory map to different places in the genome anyway so don\u2019t require attention to overlapping reads. Finally, the methylation calls from the PE and SE alignments can merged together before proceeding to the <code>bismark2bedGraph</code> or further downstream steps. A sample command for this would be:</p> <pre><code>bismark2bedGraph -o SE_and_PE_merged.bedGraph CpG*\n</code></pre> <p>If you are feeling adventurous you could also attempt using local alignments (option <code>--local</code> in Bismark) for either the paired-end step, or the second single-end step, or both. (Please also see our thoughts on local alignments/ soft-clipping.</p>"},{"location":"faq/single_cell_pbat/#single-cell-data","title":"Single-cell data","text":"<p>Because of the issues described above we have traditionally aligned single-cell data in single-end mode from the start (after hard-clipping biased positions, and adapter/quality trimming). With the more recent versions of Bismark one would in theory also have the option of using local alignments (<code>--local</code>), either on its own or in combination with the methods described above (Dirty Harry/ Wu et al.).</p>"},{"location":"options/alignment/","title":"Alignment","text":""},{"location":"options/alignment/#appendix-ii-bismark","title":"Appendix (II): Bismark","text":"<p>A brief description of Bismark and a full list of options can also be viewed by typing: <code>bismark --help</code></p>"},{"location":"options/alignment/#usage","title":"USAGE:","text":"<pre><code>bismark [options] --genome &lt;genome_folder&gt; {-1 &lt;mates1&gt; -2 &lt;mates2&gt; | &lt;singles&gt;}\n</code></pre>"},{"location":"options/alignment/#arguments","title":"ARGUMENTS:","text":"<ul> <li><code>&lt;genome_folder&gt;</code></li> </ul> <p>The full path to the folder containing the unmodified reference genome as well as the sub folders created by the <code>bismark_genome_preparation</code> script (<code>Bisulfite_Genome/CT_conversion/</code> and <code>Bisulfite_Genome/GA_conversion/</code>). Bismark expects one or more <code>FastA</code> files in this folder (file extension: <code>.fa</code> or <code>.fasta</code>). The path to the genome folder can be relative or absolute. The path may also be set as <code>--genome_folder /path/to/genome/folder/</code>.</p> <ul> <li><code>-1 &lt;mates1&gt;</code></li> </ul> <p>Comma-separated list of files containing the #1 mates (filename usually includes <code>_1</code>), e.g. <code>flyA_1.fq</code>, <code>flyB_1.fq</code>). Sequences specified with this option must correspond file-for-file and read-for-read with those specified in <code>&lt;mates2&gt;</code>. Reads may be a mix of different lengths. Bismark will produce one mapping result and one report file per paired-end input file pair.</p> <ul> <li><code>-2 &lt;mates2&gt;</code></li> </ul> <p>Comma-separated list of files containing the #2 mates (filename usually includes <code>_2</code>), e.g. <code>flyA_2.fq</code>, <code>flyB_2.fq</code>). Sequences specified with this option must correspond file-for-file and read-for-read with those specified in <code>&lt;mates1&gt;</code>. Reads may be a mix of different lengths.</p> <ul> <li><code>&lt;singles&gt;</code></li> </ul> <p>A comma or space separated list of files containing the reads to be aligned (e.g. <code>lane1.fq</code>,<code>lane2.fq</code> <code>lane3.fq</code>). Reads may be a mix of different lengths. Bismark will produce one mapping result and one report file per input file.</p>"},{"location":"options/alignment/#options","title":"OPTIONS:","text":""},{"location":"options/alignment/#input","title":"Input:","text":"<ul> <li><code>--se &lt;list&gt;</code> / <code>--single_end &lt;list&gt;</code></li> </ul> <p>Sets single-end mapping mode explicitly giving a list of file names as . The filenames may be provided as a comma [<code>,</code>] or colon [<code>:</code>]-separated list. <ul> <li><code>-q</code> / <code>--fastq</code></li> </ul> <p>The query input files (specified as <code>&lt;mate1&gt;</code>, <code>&lt;mate2&gt;</code> or <code>&lt;singles&gt;</code> are FastQ files (usually having extension <code>.fq</code> or <code>.fastq</code>). Input files may also be <code>gzip</code> compressed (ending in <code>.gz</code>). This is the default. See also <code>--solexa-quals</code> and <code>--integer-quals</code>.</p> <ul> <li><code>-f</code> / <code>--fasta</code></li> </ul> <p>The query input files (specified as <code>&lt;mate1&gt;</code>, <code>&lt;mate2&gt;</code> or <code>&lt;singles&gt;</code> are FastA files (usually having extension <code>.fa</code>, <code>.mfa</code>, <code>.fna</code> or similar). Input files may also be <code>gzip</code> compressed (ending in <code>.gz</code>). All quality values are assumed to be 40 on the Phred scale. FASTA files are expected to contain the read name and the sequence on a single line each (and not spread over several lines)</p> <ul> <li><code>-s &lt;int&gt;</code> / <code>--skip &lt;int&gt;</code></li> </ul> <p>Skip (i.e. do not align) the first &lt;int&gt; reads or read pairs from the input.</p> <ul> <li><code>-u &lt;int&gt;</code> / <code>--upto &lt;int&gt;</code></li> </ul> <p>Only aligns the first &lt;int&gt; reads or read pairs from the input. Default: no limit.</p> <ul> <li><code>--phred33-quals</code></li> </ul> <p>FastQ qualities are ASCII chars equal to the Phred quality plus 33. Default: ON.</p> <ul> <li><code>--phred64-quals</code></li> </ul> <p>FastQ qualities are ASCII chars equal to the Phred quality plus 64. Default: OFF.</p> <ul> <li><code>--path_to_bowtie2</code></li> </ul> <p>The full path <code>&lt;/../../&gt;</code> to the Bowtie 2 installation on your system. If not specified it will be assumed that Bowtie 2 is in the <code>PATH</code>.</p> <ul> <li><code>--path_to_hisat2</code></li> </ul> <p>The full path <code>&lt;/../../&gt;</code> to the HISAT2 installation on your system. If not specified it will be assumed that HISAT2 is in the <code>PATH</code>.</p>"},{"location":"options/alignment/#alignment","title":"Alignment:","text":"<ul> <li><code>-N &lt;int&gt;</code></li> </ul> <p>Sets the number of mismatches to be allowed in a seed alignment during multiseed alignment. Can be set to 0 or 1. Setting this higher makes alignment slower (often much slower) but increases sensitivity. Default: 0.</p> <ul> <li><code>-L &lt;int&gt;</code></li> </ul> <p>Sets the length of the seed substrings to align during multiseed alignment. Smaller values make alignment slower but more sensitive. Default: the <code>--sensitive</code> preset of Bowtie 2 is used by default, which sets <code>-L</code> to 20.</p> <ul> <li><code>--ignore-quals</code></li> </ul> <p>When calculating a mismatch penalty, always consider the quality value at the mismatched position to be the highest possible, regardless of the actual value. i.e. input is treated as though all quality values are high. This is also the default behaviour when the input doesn't specify quality values (e.g. in <code>-f</code> mode). For bisulfite alignments in Bismark, this option is invariably turned on by default.</p> <ul> <li><code>-I &lt;int&gt;</code> / <code>--minins &lt;int&gt;</code></li> </ul> <p>The minimum insert size for valid paired-end alignments. E.g. if <code>-I 60</code> is specified and a paired-end alignment consists of two 20-bp alignments in the appropriate orientation with a 20-bp gap between them, that alignment is considered valid (as long as <code>-X</code> is also satisfied). A 19-bp gap would not be valid in that case. Default: 0.</p> <ul> <li><code>-X &lt;int&gt;</code> / <code>--maxins &lt;int&gt;</code></li> </ul> <p>The maximum insert size for valid paired-end alignments. E.g. if <code>-X 100</code> is specified and a paired-end alignment consists of two 20-bp alignments in the proper orientation with a 60-bp gap between them, that alignment is considered valid (as long as <code>-I</code> is also satisfied). A 61-bp gap would not be valid in that case. Default: 500.</p> <ul> <li><code>--parallel &lt;int&gt;</code></li> </ul> <p>(May also be --multicore ). Sets the number of parallel instances of Bismark to be run concurrently. This forks the Bismark alignment step very early on so that each individual Spawn of Bismark processes only every n-th sequence (n being set by <code>--multicore</code>). Once all processes have completed, the individual BAM files, mapping reports, unmapped or ambiguous FastQ files are merged into single files in very much the same way as they would have been generated running Bismark conventionally with only a single instance. <p>If system resources are plentiful this is a viable option to speed up the alignment process (we observed a near linear speed increase for up to <code>--multicore 8</code> tested). However, please note that a typical Bismark run will use several cores already (Bismark itself, 2 or 4 threads for Bowtie/Bowtie2, Samtools, gzip etc...) and ~10-16GB of memory per thread depending on the choice of aligner and genome. WARNING: Bismark Parallel is resource hungry! Each value of <code>--multicore</code> specified will effectively lead to a linear increase in compute and memory requirements, so <code>--parallel 4</code> for e.g. the GRCm38 mouse genome will probably use ~20 cores and eat ~48GB of RAM, but at the same time reduce the alignment time to ~25-30%. You have been warned.</p> <ul> <li><code>--local</code></li> </ul> <p>In this mode, it is not required that the entire read aligns from one end to the other. Rather, some characters may be omitted (\u201csoft-clipped\u201d) from the ends in order to achieve the greatest possible alignment score. For Bowtie 2, the match bonus <code>--ma</code> (default: 2) is used in this mode, and the best possible alignment score is equal to the match bonus (<code>--ma</code>) times the length of the read. This is mutually exclusive with end-to-end alignments. DEFAULT: OFF.</p>"},{"location":"options/alignment/#output","title":"Output:","text":"<ul> <li><code>--non_directional</code></li> </ul> <p>The sequencing library was constructed in a non strand-specific manner, alignments to all four bisulfite strands will be reported.   (The current Illumina protocol for BS-Seq is directional, in which case the strands complementary to the original strands are merely theoretical and should not exist in reality. Specifying directional alignments (which is the default) will only run 2 alignment threads to the original top (OT) or bottom (OB) strands in parallel and report these alignments. This is the recommended option for strand-specific libraries).   Default: OFF</p> <ul> <li><code>--pbat</code></li> </ul> <p>This option may be used for PBAT-Seq libraries (Post-Bisulfite Adapter Tagging; Kobayashi et al., PLoS Genetics, 2012). This is essentially the exact opposite of alignments in 'directional' mode, as it will only launch two alignment threads to the CTOT and CTOB strands instead of the normal OT and OB ones. Use this option only if you are certain that your libraries were constructed following a PBAT protocol (if you don't know what PBAT-Seq is you should not specify this option). The option <code>--pbat</code> works only for FastQ files and uncompressed temporary files.</p> <ul> <li><code>--sam-no-hd</code></li> </ul> <p>Suppress SAM header lines (starting with @). This might be useful when very large input files are split up into several smaller files to run concurrently and the output files are to be merged afterwards.</p> <ul> <li><code>--rg_tag</code></li> </ul> <p>Write out a Read Group tag to the resulting SAM/BAM file. This will write the following line to the SAM header:</p> <p>@RG PL: ILLUMINA ID:SAMPLE SM:SAMPLE</p> <p>to set ID and SM see <code>--rg_id</code> and <code>--rg_sample</code>. In addition each read receives an <code>RG:Z:RG-ID</code> tag. Default: OFF (to not inflate file sizes).</p> <ul> <li><code>--rg_id &lt;string&gt;</code></li> </ul> <p>Sets the ID field in the <code>@RG</code> header line. Default: SAMPLE</p> <ul> <li><code>--rg_sample &lt;string&gt;</code></li> </ul> <p>Sets the SM field in the <code>@RG</code> header line; can't be set without setting <code>--rg_id</code> as well. Default: SAMPLE</p> <ul> <li><code>--quiet</code></li> </ul> <p>Print nothing besides alignments.</p> <ul> <li><code>--un</code></li> </ul> <p>Write all reads that could not be aligned to the file <code>_unmapped_reads.fq.gz</code> in the output directory. Written reads will appear as they did in the input, without any translation of quality values that may have taken place within <code>Bowtie</code> or <code>Bismark</code>. Paired-end reads will be written to two parallel files with <code>_1</code> and <code>_2</code> inserted in their filenames, i.e. <code>unmapped_reads_1.fq.gz</code> and <code>unmapped_reads_2.fq.gz</code>. Reads with more than one valid alignment with the same number of lowest mismatches (ambiguous mapping) are also written to <code>unmapped_reads.fq.gz</code> unless <code>--ambiguous</code> is also specified.</p> <ul> <li><code>--ambiguous</code></li> </ul> <p>Write all reads which produce more than one valid alignment with the same number of lowest mismatches or other reads that fail to align uniquely to <code>_ambiguous_reads.fq</code>. Written reads will appear as they did in the input, without any of the translation of quality values that may have taken place within <code>Bowtie</code> or <code>Bismark</code>. Paired-end reads will be written to two parallel files with <code>_1</code> and <code>_2</code> inserted in their filenames, i.e. <code>_ambiguous_reads_1.fq</code> and <code>_ambiguous_reads_2.fq</code>. These reads are not written to the file specified with <code>--un</code>.</p> <ul> <li><code>-o/--output_dir &lt;dir&gt;</code></li> </ul> <p>Write all output files into this directory. By default the output files will be written into the same folder as the input file. If the specified folder does not exist, Bismark will attempt to create it first. The path to the output folder can be either relative or absolute.</p> <ul> <li><code>--temp_dir &lt;dir&gt;</code></li> </ul> <p>Write temporary files to this directory instead of into the same directory as the input files. If the specified folder does not exist, Bismark will attempt to create it first. The path to the temporary folder can be either relative or absolute.</p> <ul> <li><code>--non_bs_mm</code></li> </ul> <p>Optionally outputs an extra column specifying the number of non-bisulfite mismatches a read during the alignment step. This option is only available for SAM format. In Bowtie 2 context, this value is just the number of actual non-bisulfite mismatches and ignores potential insertions or deletions. The format for single-end reads and read 1 of paired-end reads is <code>XA:Z:number of mismatches</code> and <code>XB:Z:number of mismatches</code> for read 2 of paired-end reads.</p> <ul> <li><code>--gzip</code></li> </ul> <p>Temporary bisulfite conversion files will be written out in a <code>GZIP</code> compressed form to save disk space. This option is available for most alignment modes but is not available for paired-end <code>FastA</code> files.</p> <ul> <li><code>--sam</code></li> </ul> <p>The output will be written out in <code>SAM</code> format instead of the default <code>BAM</code> format.</p> <ul> <li><code>--cram</code></li> </ul> <p>Writes the output to a <code>CRAM</code> file instead of <code>BAM</code>. This requires the use of Samtools 1.2 or higher.</p> <ul> <li><code>--cram_ref &lt;ref_file&gt;</code></li> </ul> <p><code>CRAM</code> output requires you to specify a reference genome as a single FastA file. If this single-FastA reference file is not supplied explicitly it will be regenerated from the genome <code>.fa</code> sequence(s) used for the Bismark run and written to a file called <code>Bismark_genome_CRAM_reference.mfa</code> into the output directory.</p> <ul> <li><code>--samtools_path</code></li> </ul> <p>The path to your <code>Samtools</code> installation, e.g. <code>/home/user/samtools/</code>. Does not need to be specified explicitly if <code>Samtools</code> is in the <code>PATH</code> already.</p> <ul> <li><code>--prefix &lt;prefix&gt;</code></li> </ul> <p>Prefixes <code>&lt;prefix&gt;</code> to the output file names. Trailing dots will be replaced by a single one. For example, <code>--prefix test</code> with <code>file.fq</code> would result in the output file <code>test.file_bismark.bam</code> etc.</p> <ul> <li><code>-B/--basename &lt;basename&gt;</code></li> </ul> <p>Write all output to files starting with this base file name. For example, <code>--basename foo</code> would result in the files <code>foo.bam</code> and <code>foo_SE_report.txt</code> (or its paired-end equivalent). Takes precedence over <code>--prefix</code>.</p> <ul> <li><code>--old_flag</code></li> </ul> <p>Only in paired-end SAM mode, uses the FLAG values used by Bismark 0.8.2 and before. In addition, this options appends /1 and /2 to the read IDs for reads 1 and 2 relative to the input file. Since both the appended read IDs and custom FLAG values may cause problems with some downstream tools such as Picard, new defaults were implemented as of version 0.8.3.</p> <pre><code>            default                  old_flag\n       ===================     ===================\n       Read 1       Read 2     Read 1       Read 2\n     OT:    99           147        67           131\n     OB:    83           163       115           179\n     CTOT:  99           147        67           131\n     CTOB:  83           163       115           179\n</code></pre> <ul> <li><code>--ambig_bam</code></li> </ul> <p>For reads that have multiple alignments a random alignment is written out to a special file ending in <code>.ambiguous.bam</code>. The alignments are in Bowtie2 format and do not any contain Bismark specific entries such as the methylation call etc. These ambiguous BAM files are intended to be used as coverage estimators for variant callers.</p> <ul> <li><code>--nucleotide_coverage</code></li> </ul> <p>Calculates the mono- and di-nucleotide sequence composition of covered positions in the analysed BAM file and compares it to the genomic average composition once alignments are complete by calling <code>bam2nuc</code>. Since this calculation may take a while, <code>bam2nuc</code> attempts to write the genomic sequence composition into a file called genomic_nucleotide_frequencies.txt inside the reference genome folder so it can be re-used the next time round instead of calculating it once again. If a file nucleotide_stats.txt is found with the Bismark reports it will be automatically detected and used for the Bismark HTML report. This option works only for BAM or CRAM files.</p>"},{"location":"options/alignment/#other","title":"Other:","text":"<ul> <li><code>-h/--help</code></li> </ul> <p>Displays this help file. Displays version information.</p> <ul> <li><code>-v/--version</code></li> </ul> <p>Displays version information and exits.</p>"},{"location":"options/alignment/#bowtie-2-specific-options","title":"BOWTIE 2 SPECIFIC OPTIONS","text":"<ul> <li><code>--bowtie2</code></li> </ul> <p>Default: ON. Uses Bowtie 2. Bismark limits Bowtie 2 to only perform end-to-end alignments, i.e. searches for alignments involving all read characters (also called untrimmed or unclipped alignments). Bismark assumes that raw sequence data is adapter and/or quality trimmed where appropriate. Both small (<code>.bt2</code>) and large (<code>.bt2l</code>) Bowtie 2 indexes are supported.</p> <ul> <li><code>--no_dovetail</code></li> </ul> <p>It is possible, though unusual, for the mates to \"dovetail\", with the mates seemingly extending \"past\" each other as in this example:</p> <pre><code>                     Mate 1:                 GTCAGCTACGATATTGTTTGGGGTGACACATTACGC\n                     Mate 2:            TATGAGTCAGCTACGATATTGTTTGGGGTGACACAT\n                     Reference: GCAGATTATATGAGTCAGCTACGATATTGTTTGGGGTGACACATTACGCGTCTTTGAC\n</code></pre> <p>Dovetailing is considered inconsistent with concordant alignment, but by default Bismark calls Bowtie 2 with <code>--dovetail</code>, causing it to consider dovetailing alignments as concordant. This becomes relevant whenever reads are clipped from their 5' end prior to mapping, e.g. because of quality or bias issues such as in PBAT or EM-seq libraries.</p> <p>Specify <code>--no_dovetail</code> to turn off this behaviour for paired-end libraries. Default: OFF.</p>"},{"location":"options/alignment/#hisat2-specific-options","title":"HISAT2 SPECIFIC OPTIONS:","text":"<ul> <li><code>--hisat2</code></li> </ul> <p>Default: OFF. Uses HISAT2. Bismark limits HISAT2 to perform end-to-end alignments, i.e. searches for alignments involving all read characters (also called untrimmed or unclipped alignments) using the option <code>--no-softclipping</code>. Bismark assumes that raw sequence data is adapter and/or quality trimmed where appropriate. Both small (<code>.ht2</code>) and large (<code>.ht2l</code>) HISAT2 indexes are supported.</p> <ul> <li><code>--no-spliced-alignment</code></li> </ul> <p>Disable spliced alignment.</p> <ul> <li><code>--known-splicesite-infile &lt;path&gt;</code></li> </ul> <p>Provide a list of known splice sites.</p>"},{"location":"options/alignment/#paired-end-options","title":"Paired-end options:","text":"<ul> <li><code>--no-mixed</code></li> </ul> <p>This option disables the behaviour to try to find alignments for the individual mates if it cannot find a concordant or discordant alignment for a pair. This option is invariably on by default.</p> <ul> <li><code>--no-discordant</code></li> </ul> <p>Normally, Bowtie 2 or HISAT2 look for discordant alignments if they cannot find any concordant alignments. A discordant alignment is an alignment where both mates align uniquely, but that does not satisfy the paired-end constraints (<code>--fr</code>/<code>--rf</code>/<code>--ff</code>, <code>-I</code>, <code>-X</code>). This option disables that behaviour and is on by default.</p>"},{"location":"options/alignment/#bowtie-2-effort-options","title":"Bowtie 2 Effort options:","text":"<ul> <li><code>-D &lt;int&gt;</code></li> </ul> <p>Up to &lt;int&gt; consecutive seed extension attempts can \"fail\" before Bowtie 2 moves on, using the alignments found so far. A seed extension \"fails\" if it does not yield a new best or a new second-best alignment. Default: 15.</p> <ul> <li><code>-R &lt;int&gt;</code></li> </ul> <p>&lt;int&gt; is the maximum number of times Bowtie 2 will \"re-seed\" reads with repetitive seeds. When \"re-seeding,\" Bowtie 2 simply chooses a new set of reads (same length, same number of mismatches allowed) at different offsets and searches for more alignments. A read is considered to have repetitive seeds if the total number of seed hits divided by the number of seeds that aligned at least once is greater than 300. Default: 2.</p>"},{"location":"options/alignment/#parallelization-options","title":"Parallelization options:","text":"<ul> <li><code>-p NTHREADS</code></li> </ul> <p>Launch NTHREADS parallel search threads (default: 1). Threads will run on separate processors/cores and synchronize when parsing reads and outputting alignments. Searching for alignments is highly parallel, and speed-up is close to linear. NOTE: It is currently unclear whether this speed increase also translates into a speed increase of Bismark since it is running several instances of Bowtie 2 concurrently! Increasing <code>-p</code> increases Bowtie 2's memory footprint. E.g. when aligning to a human genome index, increasing <code>-p</code> from 1 to 8 increases the memory footprint by a few hundred megabytes (for each instance of Bowtie 2!). This option is only available if Bowtie is linked with the pthreads library (i.e. if BOWTIE_PTHREADS=0 is not specified at build time). In addition, this option will automatically use the option <code>--reorder</code>, which guarantees that output SAM records are printed in an order corresponding to the order of the reads in the original input file, even when <code>-p</code> is set greater than 1 (Bismark requires the Bowtie 2 output to be this way). Specifying <code>--reorder</code> and setting <code>-p</code> greater than 1 causes Bowtie 2 to run somewhat slower and use somewhat more memory than if <code>--reorder</code> were not specified. Has no effect if <code>-p</code> is set to 1, since output order will naturally correspond to input order in that case.</p>"},{"location":"options/alignment/#scoring-options","title":"Scoring options:","text":"<ul> <li><code>--score_min &lt;func&gt;</code></li> </ul> <p>Sets a function governing the minimum alignment score needed for an alignment to be considered \"valid\" (i.e. good enough to report). This is a function of read length. For instance, specifying <code>L,0,-0.2</code> sets the minimum-score function <code>f</code> to <code>f(x) = 0 + -0.2 * x</code>, where <code>x</code> is the read length. See also: setting function options at http://bowtie-bio.sourceforge.net/bowtie2. The default is: L,0,-0.2.</p> <ul> <li><code>--rdg &lt;int1&gt;,&lt;int2&gt;</code></li> </ul> <p>Sets the read gap open (&lt;int1&gt;) and extend (&lt;int2&gt;) penalties. A read gap of length N gets a penalty of <code>&lt;int1&gt; + N * &lt;int2&gt;</code>. Default: 5, 3.</p> <ul> <li><code>--rfg &lt;int1&gt;,&lt;int2&gt;</code></li> </ul> <p>Sets the reference gap open (&lt;int1&gt;) and extend (&lt;int2&gt;) penalties. A reference gap of length N gets a penalty of <code>&lt;int1&gt; + N * &lt;int2&gt;</code>. Default: 5, 3.</p>"},{"location":"options/genome_preparation/","title":"Genome preparation","text":""},{"location":"options/genome_preparation/#appendix-i-bismark-genome-preparation","title":"Appendix (I): Bismark Genome Preparation","text":"<p>A full list of options can also be viewed by typing: <code>bismark_genome_preparation --help</code></p>"},{"location":"options/genome_preparation/#usage-bismark_genome_preparation-options-arguments","title":"USAGE: <code>bismark_genome_preparation [options] &lt;arguments&gt;</code>","text":""},{"location":"options/genome_preparation/#options","title":"OPTIONS:","text":"<ul> <li><code>--help</code></li> </ul> <p>Displays help text.</p> <ul> <li><code>--version</code></li> </ul> <p>Displays version information and exits.</p> <ul> <li><code>--verbose</code></li> </ul> <p>Print verbose output for more details or debugging.</p> <ul> <li><code>--path_to_aligner &lt;/../../&gt;</code></li> </ul> <p>The full path to the Bowtie 2 or HISAT2 installation folder on your system (depending on which aligner/indexer you intend to use; please note that thi is the folder and not any executable). Unless this path is specified, it is assumed that the aligner in question (Bowtie 2/HISAT2) is in the PATH.</p> <ul> <li><code>--bowtie2</code></li> </ul> <p>This will create bisulfite indexes for use with Bowtie 2. Recommended for most bisulfite sequencing applications (Default: ON).</p> <ul> <li><code>--hisat2</code></li> </ul> <p>This will create bisulfite indexes for use with HISAT2. At the time of writing, this is still largely unchartered territory, and only recommended for specialist applications such as RNA-methylation analyses or SLAM-seq type applications (see also: --slam). (Default: OFF).</p> <ul> <li><code>--single_fasta</code></li> </ul> <p>Instruct the Bismark Indexer to write the converted genomes into single-entry FastA files instead of making one multi-FastA file (MFA) per chromosome. This might be useful if individual bisulfite converted chromosomes are needed (e.g. for debugging), however it can cause a problem with indexing if the number of chromosomes is vast (this is likely to be in the range of several thousand files; operating systems can only handle lists up to a certain length. Some newly assembled genomes may contain 20000-500000 contig of scaffold files which do exceed this list length limit).</p> <ul> <li><code>--genomic_composition</code></li> </ul> <p>Calculate and extract the genomic sequence composition for mono- and di-nucleotides and write the genomic composition table genomic_nucleotide_frequencies.txt to the genome folder. This may be useful later on when using <code>bam2nuc</code> or the Bismark option <code>--nucleotide_coverage</code>.</p> <ul> <li><code>--slam</code></li> </ul> <p>Instead of performing an in-silico bisulfite conversion, this mode transforms T to C (forward strand), or A to G (reverse strand). The folder structure and rest of the indexing process is currently exactly the same as for bisulfite sequences, but this might change at some point. This means that a genome prepared in --slam mode is currently indistinguishable from a true Bisulfite Genome, so please make sure you name the genome folder appropriately to avoid confusion.</p>"},{"location":"options/genome_preparation/#arguments","title":"ARGUMENTS:","text":"<ul> <li><code>&lt;path_to_genome_folder&gt;</code></li> </ul> <p>The path to the folder containing the genome to be bisulfite converted (this may be an absolute or relative path). Bismark Genome Preparation expects one or more <code>FastA</code> files in the folder (valid file extensions: <code>.fa</code> or <code>.fasta</code>).</p>"},{"location":"options/methylation_extraction/","title":"Methylation extraction","text":""},{"location":"options/methylation_extraction/#appendix-iii-bismark-methylation-extractor","title":"Appendix (III): Bismark Methylation Extractor","text":"<p>A brief description of the Bismark methylation extractor and a full list of options can also be viewed by typing <code>bismark_methylation_extractor --help</code></p>"},{"location":"options/methylation_extraction/#usage-bismark_methylation_extractor-options-filenames","title":"USAGE: <code>bismark_methylation_extractor [options] &lt;filenames&gt;</code>","text":""},{"location":"options/methylation_extraction/#arguments","title":"ARGUMENTS:","text":"<ul> <li><code>&lt;filenames&gt;</code></li> </ul> <p>A space-separated list of Bismark result files in SAM format from which methylation information is extracted for every cytosine in the reads. For alignment files in the older custom Bismark output see option <code>--vanilla</code>.</p>"},{"location":"options/methylation_extraction/#options","title":"OPTIONS:","text":"<ul> <li><code>-s/--single-end</code></li> </ul> <p>Input file(s) are Bismark result file(s) generated from single-end read data. If neither <code>-s</code> nor <code>-p</code> is set the type of experiment will be determined automatically.</p> <ul> <li><code>-p/--paired-end</code></li> </ul> <p>Input file(s) are Bismark result file(s) generated from paired-end read data. If neither <code>-s</code> nor <code>-p</code> is set the type of experiment will be determined automatically.</p> <ul> <li><code>--vanilla</code></li> </ul> <p>The Bismark result input file(s) are in the old custom Bismark format (up to version 0.5.x) and not in SAM format which is the default as of Bismark version 0.6.x or higher. Default: OFF.</p> <ul> <li><code>--no_overlap</code></li> </ul> <p>For paired-end reads it is theoretically possible that Read 1 and Read 2 overlap. This option avoids scoring overlapping methylation calls twice (only methylation calls of read 1 are used for in the process since read 1 has historically higher quality basecalls than read 2). Whilst this option removes a bias towards more methylation calls in the center of sequenced fragments it may de facto remove a sizeable proportion of the data. This option is on by default for paired-end data but can be disabled using <code>--include_overlap</code>. Default: ON.</p> <ul> <li><code>--include_overlap</code></li> </ul> <p>For paired-end data all methylation calls will be extracted irrespective of whether they overlap or not. Default: OFF.</p> <ul> <li><code>--ignore &lt;int&gt;</code></li> </ul> <p>Ignore the first &lt;int&gt; bp from the 5' end of Read 1 (or single-end alignment files) when processing the methylation call string. This can remove e.g. a restriction enzyme site at the start of each read or any other source of bias (such as PBAT-Seq data).</p> <ul> <li><code>--ignore_r2 &lt;int&gt;</code></li> </ul> <p>Ignore the first &lt;int&gt; bp from the 5' end of Read 2 of paired-end sequencing results only. Since the first couple of bases in Read 2 of BS-Seq experiments show a severe bias towards non-methylation as a result of end-repairing sonicated fragments with unmethylated cytosines (see M-bias plot), it is recommended that the first couple of bp of Read 2 are removed before starting downstream analysis. Please see the section on M-bias plots in the Bismark User Guide for more details.</p> <ul> <li><code>--ignore_3prime &lt;int&gt;</code></li> </ul> <p>Ignore the last &lt;int&gt; bp from the 3' end of Read 1 (or single-end alignment files) when processing the methylation call string. This can remove unwanted biases from the end of reads.</p> <ul> <li><code>--ignore_3prime_r2 &lt;int&gt;</code></li> </ul> <p>Ignore the last &lt;int&gt; bp from the 3' end of Read 2 of paired-end sequencing results only. This can remove unwanted biases from the end of reads.</p> <ul> <li><code>--comprehensive</code></li> </ul> <p>Specifying this option will merge all four possible strand-specific methylation info into context-dependent output files. The default contexts are:</p> <ul> <li>CpG context</li> <li>CHG context</li> <li> <p>CHH context</p> </li> <li> <p><code>--merge_non_CpG</code></p> </li> </ul> <p>This will produce two output files (in <code>--comprehensive mode</code>) or eight strand-specific output files (default) for Cs in</p> <ul> <li>CpG context</li> <li> <p>non-CpG context</p> </li> <li> <p><code>--report</code></p> </li> </ul> <p>Prints out a short methylation summary as well as the parameters used to run this script. Default: ON.</p> <ul> <li><code>--no_header</code></li> </ul> <p>Suppresses the Bismark version header line in all output files for more convenient batch processing.</p> <ul> <li><code>-o/--output DIR</code></li> </ul> <p>Allows specification of a different output directory (absolute or relative path). If not specified explicitly, the output will be written to the current directory.</p> <ul> <li><code>--samtools_path</code></li> </ul> <p>The path to your Samtools installation, e.g. /home/user/samtools/. Does not need to be specified explicitly if Samtools is in the PATH already.</p> <ul> <li><code>--gzip</code></li> </ul> <p>The methylation extractor files (CpG_OT_..., CpG_OB_... etc) will be written out in a <code>GZIP</code> compressed form to save disk space. This option is also passed on to the genome-wide cytosine report. <code>bedGraph</code> and <code>coverage</code> files are written out as <code>.gz</code> by default.</p> <ul> <li><code>--mbias_only</code></li> </ul> <p>The methylation extractor will read the entire file but only output the M-bias table and plots as well as a report (optional) and then quit. Default: OFF.</p> <ul> <li><code>--mbias_off</code></li> </ul> <p>The methylation extractor will process the entire file as usual but doesn't write out any M-bias report. Only recommended for users who deliberately want to keep an earlier version of the M-bias report. Default: OFF.</p> <ul> <li><code>--multicore &lt;int&gt;</code></li> </ul> <p>Sets the number of cores to be used for the methylation extraction process. If system resources are plentiful this is a viable option to speed up the extraction process (we observed a near linear speed increase for up to 10 cores used). Please note that a typical process of extracting a BAM file and writing out <code>.gz</code> output streams will in fact use ~3 cores per value of <code>--multicore &lt;int&gt;</code> specified (1 for the methylation extractor itself, 1 for a Samtools stream, 1 for a GZIP stream), so <code>--multicore 10</code> is likely to use around 30 cores of system resources. This option has no bearing on the <code>bismark2bedGraph</code> or <code>coverage2cytosine</code> (genome-wide cytosine report) processes.</p> <ul> <li><code>--version</code></li> </ul> <p>Displays version information.</p> <ul> <li><code>-h/--help</code></li> </ul> <p>Displays this help file and exits.</p>"},{"location":"options/methylation_extraction/#bedgraph-specific-options","title":"bedGraph specific options:","text":"<ul> <li><code>--bedGraph</code></li> </ul> <p>After finishing the methylation extraction, the methylation output is written into a sorted <code>bedGraph</code> file that reports the position of a given cytosine and its methylation state (in %, see details below) using 0-based genomic start and 1-based end coordinates. The methylation extractor output is temporarily split up into temporary files, one per chromosome (written into the current directory or folder specified with <code>-o/--output</code>); these temp files are then used for sorting and deleted afterwards. By default, only cytosines in CpG context are sorted. The option <code>--CX_context</code> may be used to report all cytosines irrespective of sequence context (this will take MUCH longer!). The <code>bedGraph</code> conversion step is performed by the external module <code>bismark2bedGraph</code>; this script needs to reside in the same folder as the bismark_methylation_extractor itself.</p> <ul> <li><code>--zero_based</code></li> </ul> <p>Write out an additional coverage file (ending in <code>.zero.cov</code>) that uses 0-based genomic start and 1-based genomic end coordinates (zero-based, half-open), like used in the <code>bedGraph</code> file, instead of using 1-based coordinates throughout. Default: OFF.</p> <ul> <li><code>--cutoff [threshold]</code></li> </ul> <p>The minimum number of times any methylation state (methylated or unmethylated) has to be seen for a nucleotide before its methylation percentage is reported. Default: 1.</p> <ul> <li><code>--remove_spaces</code></li> </ul> <p>Replaces white spaces in the sequence ID field with underscores to allow sorting.</p> <ul> <li><code>--CX/--CX_context</code></li> </ul> <p>The sorted <code>bedGraph</code> output file contains information on every single cytosine that was covered in the experiment irrespective of its sequence context. This applies to both forward and reverse strands. Please be aware that this option may generate large temporary and output files and may take a long time to sort (up to many hours). Default: OFF (i.e. Default = CpG context only).</p> <ul> <li><code>--buffer_size &lt;string&gt;</code></li> </ul> <p>This allows you to specify the main memory sort buffer when sorting the methylation information. Either specify a percentage of physical memory by appending % (e.g. <code>--buffer_size 50%</code>) or a multiple of 1024 bytes, e.g. <code>K</code> multiplies by 1024, <code>M</code> by 1048576 and so on for <code>T</code> etc. (e.g. <code>--buffer_size 20G</code>). For more information on sort type <code>info sort</code> on a command line. Defaults to 2G.</p> <ul> <li><code>--scaffolds/--gazillion</code></li> </ul> <p>Users working with unfinished genomes sporting tens or even hundreds of thousands of scaffolds/contigs/chromosomes frequently encountered errors with pre-sorting reads to individual chromosome files. These errors were caused by the operating system's limit of the number of filehandles that can be written to at any one time (typically 1024; to find out this limit on Linux, type: <code>ulimit -a</code>). To bypass the limitation of open filehandles, the option <code>--scaffolds</code> does not pre-sort methylation calls into individual chromosome files. Instead, all input files are temporarily merged into a single file (unless there is only a single file), and this file will then be sorted by both chromosome AND position using the Unix sort command. Please be aware that this option might take a looooong time to complete, depending on the size of the input files, and the memory you allocate to this process (see <code>--buffer_size</code>). Nevertheless, it seems to be working.</p> <ul> <li><code>--ample_memory</code></li> </ul> <p>Using this option will not sort chromosomal positions using the UNIX <code>sort</code> command, but will instead use two arrays to sort methylated and unmethylated calls. This may result in a faster sorting process of very large files, but this comes at the cost of a larger memory footprint (two arrays of the length of the largest human chromosome 1 (~250M bp) consume around 16GB of RAM). Due to overheads in creating and looping through these arrays it seems that it will actually be slower for small files (few million alignments), and we are currently testing at which point it is advisable to use this option. Note that <code>--ample_memory</code> is not compatible with options <code>--scaffolds/--gazillion</code> (as it requires pre-sorted files to begin with).</p>"},{"location":"options/methylation_extraction/#genome-wide-cytosine-methylation-report-specific-options","title":"Genome-wide cytosine methylation report specific options:","text":"<ul> <li><code>--cytosine_report</code></li> </ul> <p>After the conversion to bedGraph has completed, the option <code>--cytosine_report</code> produces a genome-wide methylation report for all cytosines in the genome. By default, the output uses 1-based chromosome coordinates (zero-based start coords are optional) and reports CpG context only (all cytosine context is optional). The output considers all Cs on both forward and reverse strands and reports their position, strand, trinucleotide content and methylation state (counts are 0 if not covered). The cytosine report conversion step is performed by the external module <code>coverage2cytosine</code>; this script needs to reside in the same folder as the bismark_methylation_extractor itself.</p> <ul> <li><code>--CX/--CX_context</code></li> </ul> <p>The output file contains information on every single cytosine in the genome irrespective of its context. This applies to both forward and reverse strands. Please be aware that this will generate output files with &gt; 1.1 billion lines for a mammalian genome such as human or mouse. Default: OFF (i.e. Default = CpG context only).</p> <ul> <li><code>--zero_based</code></li> </ul> <p>Uses 0-based genomic coordinates instead of 1-based coordinates. Default: OFF.</p> <ul> <li><code>--genome_folder &lt;path&gt;</code></li> </ul> <p>Enter the genome folder you wish to use to extract sequences from (full path only). Accepted formats are FastA files ending with <code>.fa</code> or <code>.fasta</code>. Specifying a genome folder path is mandatory.</p> <ul> <li><code>--split_by_chromosome</code></li> </ul> <p>Writes the output into individual files for each chromosome instead of a single output file. Files are named to include the input filename as well as the chromosome number.</p>"},{"location":"options/methylation_extraction/#output","title":"OUTPUT","text":""},{"location":"options/methylation_extraction/#the-bismark_methylation_extractor-output-is-in-the-form-tab-delimited-1-based-coords","title":"The bismark_methylation_extractor output is in the form (tab delimited, 1-based coords):","text":"<pre><code>&lt;seq-ID&gt; &lt;methylation state*&gt; &lt;chromosome&gt; &lt;start position (= end position)&gt; &lt;methylation call&gt;\n\n  Methylated cytosines receive a '+' orientation,\nUnmethylated cytosines receive a '-' orientation.\n</code></pre>"},{"location":"options/methylation_extraction/#the-bedgraph-output-optional-looks-like-this-tab-delimited-0-based-start-1-based-end-coords","title":"The bedGraph output (optional) looks like this (tab-delimited, 0-based start, 1-based end coords):","text":"<pre><code>track type=bedGraph (header line)\n&lt;chromosome&gt; &lt;start position&gt; &lt;end position&gt; &lt;methylation percentage&gt;\n</code></pre>"},{"location":"options/methylation_extraction/#the-coverage-output-looks-like-this-tab-delimited-1-based-genomic-coords","title":"The coverage output looks like this (tab-delimited; 1-based genomic coords):","text":"<pre><code>&lt;chromosome&gt; &lt;start position&gt; &lt;end position&gt; &lt;methylation percentage&gt; &lt;count methylated&gt; &lt;count unmethylated&gt;\n</code></pre>"},{"location":"options/methylation_extraction/#the-genome-wide-cytosine-report-optional-is-tab-delimited-in-the-following-format-1-based-coords","title":"The genome-wide cytosine report (optional) is tab-delimited in the following format (1-based coords):","text":"<pre><code>&lt;chromosome&gt; &lt;position&gt; &lt;strand&gt; &lt;count methylated&gt; &lt;count unmethylated&gt; &lt;C-context&gt; &lt;trinucleotide context&gt;\n</code></pre>"}]}